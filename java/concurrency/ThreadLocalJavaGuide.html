<!doctype html>
<html lang="zh-CN" data-theme="light">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <meta name="generator" content="VuePress 2.0.0-rc.13" />
    <meta name="theme" content="VuePress Theme Hope 2.0.0-rc.48" />
    <style>
      html {
        background: var(--bg-color, #fff);
      }

      html[data-theme="dark"] {
        background: var(--bg-color, #1d1e1f);
      }

      body {
        background: var(--bg-color);
      }
    </style>
    <script>
      const userMode = localStorage.getItem("vuepress-theme-hope-scheme");
      const systemDarkMode =
        window.matchMedia &&
        window.matchMedia("(prefers-color-scheme: dark)").matches;

      if (userMode === "dark" || (userMode !== "light" && systemDarkMode)) {
        document.documentElement.setAttribute("data-theme", "dark");
      }
    </script>
    <meta property="og:url" content="https://leslie-dd.github.io/leslie-blog/leslie-blog/java/concurrency/ThreadLocalJavaGuide.html"><meta property="og:site_name" content="Leslieçš„åšå®¢"><meta property="og:title" content="ThreadLocal è¯¦è§£"><meta property="og:description" content="å‰è¨€ å¯¹äºThreadLocalï¼Œå¤§å®¶çš„ç¬¬ä¸€ååº”å¯èƒ½æ˜¯å¾ˆç®€å•å‘€ï¼Œçº¿ç¨‹çš„å˜é‡å‰¯æœ¬ï¼Œæ¯ä¸ªçº¿ç¨‹éš”ç¦»ã€‚é‚£è¿™é‡Œæœ‰å‡ ä¸ªé—®é¢˜å¤§å®¶å¯ä»¥æ€è€ƒä¸€ä¸‹ï¼š ThreadLocalçš„ key æ˜¯å¼±å¼•ç”¨ï¼Œé‚£ä¹ˆåœ¨ ThreadLocal.get()çš„æ—¶å€™ï¼Œå‘ç”ŸGCä¹‹åï¼Œkey æ˜¯å¦ä¸ºnullï¼Ÿ ThreadLocalä¸­ThreadLocalMapçš„æ•°æ®ç»“æ„ï¼Ÿ ThreadLocalM..."><meta property="og:type" content="article"><meta property="og:image" content="https://oss.javaguide.cn/java-guide-blog/view.png"><meta property="og:locale" content="zh-CN"><meta property="og:updated_time" content="2025-03-26T10:26:04.000Z"><meta property="article:author" content="Evan"><meta property="article:tag" content="Android"><meta property="article:published_time" content="2025-03-26T00:00:00.000Z"><meta property="article:modified_time" content="2025-03-26T10:26:04.000Z"><script type="application/ld+json">{"@context":"https://schema.org","@type":"Article","headline":"ThreadLocal è¯¦è§£","image":["https://oss.javaguide.cn/java-guide-blog/view.png"],"datePublished":"2025-03-26T00:00:00.000Z","dateModified":"2025-03-26T10:26:04.000Z","author":[{"@type":"Person","name":"Evan"}]}</script><script src="/js/base.js"></script><title>ThreadLocal è¯¦è§£ | Leslieçš„åšå®¢</title><meta name="description" content="å‰è¨€ å¯¹äºThreadLocalï¼Œå¤§å®¶çš„ç¬¬ä¸€ååº”å¯èƒ½æ˜¯å¾ˆç®€å•å‘€ï¼Œçº¿ç¨‹çš„å˜é‡å‰¯æœ¬ï¼Œæ¯ä¸ªçº¿ç¨‹éš”ç¦»ã€‚é‚£è¿™é‡Œæœ‰å‡ ä¸ªé—®é¢˜å¤§å®¶å¯ä»¥æ€è€ƒä¸€ä¸‹ï¼š ThreadLocalçš„ key æ˜¯å¼±å¼•ç”¨ï¼Œé‚£ä¹ˆåœ¨ ThreadLocal.get()çš„æ—¶å€™ï¼Œå‘ç”ŸGCä¹‹åï¼Œkey æ˜¯å¦ä¸ºnullï¼Ÿ ThreadLocalä¸­ThreadLocalMapçš„æ•°æ®ç»“æ„ï¼Ÿ ThreadLocalM...">
    <link rel="preload" href="/leslie-blog/assets/style-BMKGoIKn.css" as="style"><link rel="stylesheet" href="/leslie-blog/assets/style-BMKGoIKn.css">
    <link rel="modulepreload" href="/leslie-blog/assets/app-C4IA4XLb.js"><link rel="modulepreload" href="/leslie-blog/assets/ThreadLocalJavaGuide.html-DFrzVku2.js"><link rel="modulepreload" href="/leslie-blog/assets/plugin-vue_export-helper-DlAUqK2U.js">
    
  </head>
  <body>
    <div id="app"><!--[--><!--[--><!--[--><span tabindex="-1"></span><a href="#main-content" class="vp-skip-link sr-only">è·³è‡³ä¸»è¦å…§å®¹</a><!--]--><div class="theme-container external-link-icon has-toc"><!--[--><header id="navbar" class="vp-navbar"><div class="vp-navbar-start"><button type="button" class="vp-toggle-sidebar-button" title="Toggle Sidebar"><span class="icon"></span></button><!----><!--[--><a class="route-link vp-brand" href="/leslie-blog/"><img class="vp-nav-logo" src="/leslie-blog/images/logo.png" alt><!----><span class="vp-site-name hide-in-pad">Leslieçš„åšå®¢</span></a><!--]--><!----></div><div class="vp-navbar-center"><!----><!--[--><nav class="vp-nav-links"><div class="vp-nav-item hide-in-mobile"><a class="route-link auto-link" href="/leslie-blog/" aria-label="ä¸»é¡µ"><!--[--><span class="font-icon icon home" style=""></span><!--]-->ä¸»é¡µ<!----></a></div><div class="vp-nav-item hide-in-mobile"><div class="vp-dropdown-wrapper"><button type="button" class="vp-dropdown-title" aria-label="å…³äº"><!--[--><!---->å…³äº<!--]--><span class="arrow"></span><ul class="vp-dropdown"><li class="vp-dropdown-item"><a class="route-link auto-link" href="/leslie-blog/about/me/self_intro.html" aria-label="About Me"><!---->About Me<!----></a></li><li class="vp-dropdown-item"><a class="route-link auto-link" href="/leslie-blog/about/site/" aria-label="About this site"><!---->About this site<!----></a></li></ul></button></div></div><div class="vp-nav-item hide-in-mobile"><div class="vp-dropdown-wrapper"><button type="button" class="vp-dropdown-title" aria-label="æ•™ç¨‹"><!--[--><!---->æ•™ç¨‹<!--]--><span class="arrow"></span><ul class="vp-dropdown"><li class="vp-dropdown-item"><a class="route-link auto-link" href="/leslie-blog/tutorial/linux/" aria-label="Linux"><!---->Linux<!----></a></li><li class="vp-dropdown-item"><a class="route-link auto-link" href="/leslie-blog/tutorial/mac/" aria-label="Mac"><!---->Mac<!----></a></li><li class="vp-dropdown-item"><a class="route-link auto-link" href="/leslie-blog/tutorial/android/" aria-label="Android"><!---->Android<!----></a></li><li class="vp-dropdown-item"><a class="route-link auto-link" href="/leslie-blog/tutorial/server/" aria-label="Server"><!---->Server<!----></a></li><li class="vp-dropdown-item"><a class="route-link auto-link" href="/leslie-blog/tutorial/git_github_tips.html" aria-label="Git &amp; GitHub"><!---->Git &amp; GitHub<!----></a></li><li class="vp-dropdown-item"><a class="route-link auto-link" href="/leslie-blog/tutorial/regex.html" aria-label="Regex"><!---->Regex<!----></a></li></ul></button></div></div><div class="vp-nav-item hide-in-mobile"><div class="vp-dropdown-wrapper"><button type="button" class="vp-dropdown-title" aria-label="Java"><!--[--><!---->Java<!--]--><span class="arrow"></span><ul class="vp-dropdown"><li class="vp-dropdown-item"><a class="route-link auto-link" href="/leslie-blog/java/JavaException.html" aria-label="Java Exception"><!---->Java Exception<!----></a></li><li class="vp-dropdown-item"><a class="route-link route-link-active auto-link" href="/leslie-blog/java/concurrency/" aria-label="Java Concurrency"><!---->Java Concurrency<!----></a></li></ul></button></div></div><div class="vp-nav-item hide-in-mobile"><a class="route-link auto-link" href="/leslie-blog/android/" aria-label="Android"><!---->Android<!----></a></div><div class="vp-nav-item hide-in-mobile"><div class="vp-dropdown-wrapper"><button type="button" class="vp-dropdown-title" aria-label="æŠ€æœ¯åšå®¢"><!--[--><!---->æŠ€æœ¯åšå®¢<!--]--><span class="arrow"></span><ul class="vp-dropdown"><li class="vp-dropdown-item"><a class="route-link auto-link" href="/leslie-blog/blog/computer/" aria-label="è®¡ç®—æœºåŸºç¡€"><!---->è®¡ç®—æœºåŸºç¡€<!----></a></li><li class="vp-dropdown-item"><a class="route-link auto-link" href="/leslie-blog/blog/server/" aria-label="åç«¯"><!---->åç«¯<!----></a></li><li class="vp-dropdown-item"><a class="route-link auto-link" href="/leslie-blog/blog/databases/" aria-label="æ•°æ®åº“"><!---->æ•°æ®åº“<!----></a></li><li class="vp-dropdown-item"><a class="route-link auto-link" href="/leslie-blog/blog/python/" aria-label="Python"><!---->Python<!----></a></li></ul></button></div></div><div class="vp-nav-item hide-in-mobile"><div class="vp-dropdown-wrapper"><button type="button" class="vp-dropdown-title" aria-label="æ•°æ®ç»“æ„"><!--[--><!---->æ•°æ®ç»“æ„<!--]--><span class="arrow"></span><ul class="vp-dropdown"><li class="vp-dropdown-item"><a class="route-link auto-link" href="/leslie-blog/datastructure/tree/" aria-label="ğŸŒ³ æ ‘"><!---->ğŸŒ³ æ ‘<!----></a></li></ul></button></div></div><div class="vp-nav-item hide-in-mobile"><div class="vp-dropdown-wrapper"><button type="button" class="vp-dropdown-title" aria-label="ç®—æ³•"><!--[--><!---->ç®—æ³•<!--]--><span class="arrow"></span><ul class="vp-dropdown"><li class="vp-dropdown-item"><a class="route-link auto-link" href="/leslie-blog/algorithms/sort/" aria-label="æ’åºç®—æ³•"><!---->æ’åºç®—æ³•<!----></a></li></ul></button></div></div><div class="vp-nav-item hide-in-mobile"><div class="vp-dropdown-wrapper"><button type="button" class="vp-dropdown-title" aria-label="é¡¹ç›®"><!--[--><!---->é¡¹ç›®<!--]--><span class="arrow"></span><ul class="vp-dropdown"><li class="vp-dropdown-item"><a class="route-link auto-link" href="/leslie-blog/projects/reading/" aria-label="Reading"><!---->Reading<!----></a></li><li class="vp-dropdown-item"><a class="route-link auto-link" href="/leslie-blog/projects/passwd/" aria-label="Passwd"><!---->Passwd<!----></a></li></ul></button></div></div><div class="vp-nav-item hide-in-mobile"><a class="route-link auto-link" href="/leslie-blog/notes/" aria-label="è¯»ä¹¦ç¬”è®°"><!---->è¯»ä¹¦ç¬”è®°<!----></a></div></nav><!--]--><!----></div><div class="vp-navbar-end"><!----><!--[--><!----><div class="vp-nav-item vp-action"><a class="vp-action-link" href="https://github.com/Leslie-DD/leslie-blog" target="_blank" rel="noopener noreferrer" aria-label="GitHub"><svg xmlns="http://www.w3.org/2000/svg" class="icon github-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="github icon" name="github" style="width:1.25rem;height:1.25rem;vertical-align:middle;"><path d="M511.957 21.333C241.024 21.333 21.333 240.981 21.333 512c0 216.832 140.544 400.725 335.574 465.664 24.49 4.395 32.256-10.07 32.256-23.083 0-11.69.256-44.245 0-85.205-136.448 29.61-164.736-64.64-164.736-64.64-22.315-56.704-54.4-71.765-54.4-71.765-44.587-30.464 3.285-29.824 3.285-29.824 49.195 3.413 75.179 50.517 75.179 50.517 43.776 75.008 114.816 53.333 142.762 40.79 4.523-31.66 17.152-53.377 31.19-65.537-108.971-12.458-223.488-54.485-223.488-242.602 0-53.547 19.114-97.323 50.517-131.67-5.035-12.33-21.93-62.293 4.779-129.834 0 0 41.258-13.184 134.912 50.346a469.803 469.803 0 0 1 122.88-16.554c41.642.213 83.626 5.632 122.88 16.554 93.653-63.488 134.784-50.346 134.784-50.346 26.752 67.541 9.898 117.504 4.864 129.834 31.402 34.347 50.474 78.123 50.474 131.67 0 188.586-114.73 230.016-224.042 242.09 17.578 15.232 33.578 44.672 33.578 90.454v135.85c0 13.142 7.936 27.606 32.854 22.87C862.25 912.597 1002.667 728.747 1002.667 512c0-271.019-219.648-490.667-490.71-490.667z"></path></svg></a></div><div class="vp-nav-item hide-in-mobile"><button type="button" class="vp-outlook-button" tabindex="-1" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" class="icon outlook-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="outlook icon" name="outlook"><path d="M224 800c0 9.6 3.2 44.8 6.4 54.4 6.4 48-48 76.8-48 76.8s80 41.6 147.2 0 134.4-134.4 38.4-195.2c-22.4-12.8-41.6-19.2-57.6-19.2C259.2 716.8 227.2 761.6 224 800zM560 675.2l-32 51.2c-51.2 51.2-83.2 32-83.2 32 25.6 67.2 0 112-12.8 128 25.6 6.4 51.2 9.6 80 9.6 54.4 0 102.4-9.6 150.4-32l0 0c3.2 0 3.2-3.2 3.2-3.2 22.4-16 12.8-35.2 6.4-44.8-9.6-12.8-12.8-25.6-12.8-41.6 0-54.4 60.8-99.2 137.6-99.2 6.4 0 12.8 0 22.4 0 12.8 0 38.4 9.6 48-25.6 0-3.2 0-3.2 3.2-6.4 0-3.2 3.2-6.4 3.2-6.4 6.4-16 6.4-16 6.4-19.2 9.6-35.2 16-73.6 16-115.2 0-105.6-41.6-198.4-108.8-268.8C704 396.8 560 675.2 560 675.2zM224 419.2c0-28.8 22.4-51.2 51.2-51.2 28.8 0 51.2 22.4 51.2 51.2 0 28.8-22.4 51.2-51.2 51.2C246.4 470.4 224 448 224 419.2zM320 284.8c0-22.4 19.2-41.6 41.6-41.6 22.4 0 41.6 19.2 41.6 41.6 0 22.4-19.2 41.6-41.6 41.6C339.2 326.4 320 307.2 320 284.8zM457.6 208c0-12.8 12.8-25.6 25.6-25.6 12.8 0 25.6 12.8 25.6 25.6 0 12.8-12.8 25.6-25.6 25.6C470.4 233.6 457.6 220.8 457.6 208zM128 505.6C128 592 153.6 672 201.6 736c28.8-60.8 112-60.8 124.8-60.8-16-51.2 16-99.2 16-99.2l316.8-422.4c-48-19.2-99.2-32-150.4-32C297.6 118.4 128 291.2 128 505.6zM764.8 86.4c-22.4 19.2-390.4 518.4-390.4 518.4-22.4 28.8-12.8 76.8 22.4 99.2l9.6 6.4c35.2 22.4 80 12.8 99.2-25.6 0 0 6.4-12.8 9.6-19.2 54.4-105.6 275.2-524.8 288-553.6 6.4-19.2-3.2-32-19.2-32C777.6 76.8 771.2 80 764.8 86.4z"></path></svg><div class="vp-outlook-dropdown"><!----></div></button></div><form class="search-box" role="search"><input type="search" placeholder="æœç´¢" autocomplete="off" spellcheck="false" value><!----></form><!--]--><!----><button type="button" class="vp-toggle-navbar-button" aria-label="Toggle Navbar" aria-expanded="false" aria-controls="nav-screen"><span><span class="vp-top"></span><span class="vp-middle"></span><span class="vp-bottom"></span></span></button></div></header><!----><!--]--><!----><div class="toggle-sidebar-wrapper"><span class="arrow start"></span></div><aside id="sidebar" class="vp-sidebar"><!----><ul class="vp-sidebar-links"><li><section class="vp-sidebar-group"><p class="vp-sidebar-header active"><!----><span class="vp-sidebar-title">Java</span><!----></p><ul class="vp-sidebar-links"><li><a class="route-link auto-link vp-sidebar-link" href="/leslie-blog/java/JavaException.html" aria-label="Java Exception"><!---->Java Exception<!----></a></li><li><section class="vp-sidebar-group"><button class="vp-sidebar-header clickable active" type="button"><!----><a class="route-link route-link-active auto-link vp-sidebar-title no-external-link-icon" href="/leslie-blog/java/concurrency/" aria-label="Java Concurrency"><!---->Java Concurrency<!----></a><span class="vp-arrow down"></span></button><ul class="vp-sidebar-links"><li><a class="route-link auto-link vp-sidebar-link" href="/leslie-blog/java/concurrency/synchronized.html" aria-label="å…³é”®å­— synchronized è¯¦è§£"><!---->å…³é”®å­— synchronized è¯¦è§£<!----></a></li><li><a class="route-link auto-link vp-sidebar-link" href="/leslie-blog/java/concurrency/volatile.html" aria-label="å…³é”®å­— volatile è¯¦è§£"><!---->å…³é”®å­— volatile è¯¦è§£<!----></a></li><li><a class="route-link auto-link vp-sidebar-link" href="/leslie-blog/java/concurrency/final.html" aria-label="å…³é”®å­— final è¯¦è§£"><!---->å…³é”®å­— final è¯¦è§£<!----></a></li><li><a class="route-link auto-link vp-sidebar-link" href="/leslie-blog/java/concurrency/memorybarrier.html" aria-label="å†…å­˜å±éšœ"><!---->å†…å­˜å±éšœ<!----></a></li><li><a class="route-link auto-link vp-sidebar-link" href="/leslie-blog/java/concurrency/java_double_check_single_instance.html" aria-label="å•ä¾‹æ¨¡å¼åŒæ£€é”"><!---->å•ä¾‹æ¨¡å¼åŒæ£€é”<!----></a></li><li><a class="route-link auto-link vp-sidebar-link" href="/leslie-blog/java/concurrency/ThreadLocal.html" aria-label="ThreadLocal è¯¦è§£"><!---->ThreadLocal è¯¦è§£<!----></a></li><li><a class="route-link route-link-active auto-link vp-sidebar-link active" href="/leslie-blog/java/concurrency/ThreadLocalJavaGuide.html" aria-label="ThreadLocal è¯¦è§£ - Java Guide"><!---->ThreadLocal è¯¦è§£ - Java Guide<!----></a></li></ul></section></li></ul></section></li></ul><!----></aside><!--[--><main id="main-content" class="vp-page"><!--[--><!----><!----><nav class="vp-breadcrumb disable"></nav><div class="vp-page-title"><h1><!---->ThreadLocal è¯¦è§£</h1><div class="page-info"><span class="page-author-info" aria-label="ä½œè€…ğŸ–Š" data-balloon-pos="up"><svg xmlns="http://www.w3.org/2000/svg" class="icon author-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="author icon" name="author"><path d="M649.6 633.6c86.4-48 147.2-144 147.2-249.6 0-160-128-288-288-288s-288 128-288 288c0 108.8 57.6 201.6 147.2 249.6-121.6 48-214.4 153.6-240 288-3.2 9.6 0 19.2 6.4 25.6 3.2 9.6 12.8 12.8 22.4 12.8h704c9.6 0 19.2-3.2 25.6-12.8 6.4-6.4 9.6-16 6.4-25.6-25.6-134.4-121.6-240-243.2-288z"></path></svg><span><span class="page-author-item">Evan</span></span><span property="author" content="Evan"></span></span><!----><span class="page-date-info" aria-label="å†™ä½œæ—¥æœŸğŸ“…" data-balloon-pos="up"><svg xmlns="http://www.w3.org/2000/svg" class="icon calendar-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="calendar icon" name="calendar"><path d="M716.4 110.137c0-18.753-14.72-33.473-33.472-33.473-18.753 0-33.473 14.72-33.473 33.473v33.473h66.993v-33.473zm-334.87 0c0-18.753-14.72-33.473-33.473-33.473s-33.52 14.72-33.52 33.473v33.473h66.993v-33.473zm468.81 33.52H716.4v100.465c0 18.753-14.72 33.473-33.472 33.473a33.145 33.145 0 01-33.473-33.473V143.657H381.53v100.465c0 18.753-14.72 33.473-33.473 33.473a33.145 33.145 0 01-33.473-33.473V143.657H180.6A134.314 134.314 0 0046.66 277.595v535.756A134.314 134.314 0 00180.6 947.289h669.74a134.36 134.36 0 00133.94-133.938V277.595a134.314 134.314 0 00-133.94-133.938zm33.473 267.877H147.126a33.145 33.145 0 01-33.473-33.473c0-18.752 14.72-33.473 33.473-33.473h736.687c18.752 0 33.472 14.72 33.472 33.473a33.145 33.145 0 01-33.472 33.473z"></path></svg><span><!----></span><meta property="datePublished" content="2025-03-26T00:00:00.000Z"></span><!----><span class="page-tag-info" aria-label="æ ‡ç­¾ğŸ·" data-balloon-pos="up"><svg xmlns="http://www.w3.org/2000/svg" class="icon tag-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="tag icon" name="tag"><path d="M939.902 458.563L910.17 144.567c-1.507-16.272-14.465-29.13-30.737-30.737L565.438 84.098h-.402c-3.215 0-5.726 1.005-7.634 2.913l-470.39 470.39a10.004 10.004 0 000 14.164l365.423 365.424c1.909 1.908 4.42 2.913 7.132 2.913s5.223-1.005 7.132-2.913l470.39-470.39c2.01-2.11 3.014-5.023 2.813-8.036zm-240.067-72.121c-35.458 0-64.286-28.828-64.286-64.286s28.828-64.285 64.286-64.285 64.286 28.828 64.286 64.285-28.829 64.286-64.286 64.286z"></path></svg><!--[--><span class="page-tag-item color0 clickable" role="navigation">Android</span><!--]--><meta property="keywords" content="Android"></span><span class="page-reading-time-info" aria-label="é˜…è¯»æ—¶é—´âŒ›" data-balloon-pos="up"><svg xmlns="http://www.w3.org/2000/svg" class="icon timer-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="timer icon" name="timer"><path d="M799.387 122.15c4.402-2.978 7.38-7.897 7.38-13.463v-1.165c0-8.933-7.38-16.312-16.312-16.312H256.33c-8.933 0-16.311 7.38-16.311 16.312v1.165c0 5.825 2.977 10.874 7.637 13.592 4.143 194.44 97.22 354.963 220.201 392.763-122.204 37.542-214.893 196.511-220.2 389.397-4.661 5.049-7.638 11.651-7.638 19.03v5.825h566.49v-5.825c0-7.379-2.849-13.981-7.509-18.9-5.049-193.016-97.867-351.985-220.2-389.527 123.24-37.67 216.446-198.453 220.588-392.892zM531.16 450.445v352.632c117.674 1.553 211.787 40.778 211.787 88.676H304.097c0-48.286 95.149-87.382 213.728-88.676V450.445c-93.077-3.107-167.901-81.297-167.901-177.093 0-8.803 6.99-15.793 15.793-15.793 8.803 0 15.794 6.99 15.794 15.793 0 80.261 63.69 145.635 142.01 145.635s142.011-65.374 142.011-145.635c0-8.803 6.99-15.793 15.794-15.793s15.793 6.99 15.793 15.793c0 95.019-73.789 172.82-165.96 177.093z"></path></svg><span>å¤§çº¦ 24 åˆ†é’Ÿ</span><meta property="timeRequired" content="PT24M"></span></div><hr></div><div class="vp-toc-placeholder"><aside id="toc"><!----><div class="vp-toc-header">æ­¤é¡µå†…å®¹<button type="button" class="print-button" title="æ‰“å°"><svg xmlns="http://www.w3.org/2000/svg" class="icon print-icon" viewBox="0 0 1024 1024" fill="currentColor" aria-label="print icon" name="print"><path d="M819.2 364.8h-44.8V128c0-17.067-14.933-32-32-32H281.6c-17.067 0-32 14.933-32 32v236.8h-44.8C145.067 364.8 96 413.867 96 473.6v192c0 59.733 49.067 108.8 108.8 108.8h44.8V896c0 17.067 14.933 32 32 32h460.8c17.067 0 32-14.933 32-32V774.4h44.8c59.733 0 108.8-49.067 108.8-108.8v-192c0-59.733-49.067-108.8-108.8-108.8zM313.6 160h396.8v204.8H313.6V160zm396.8 704H313.6V620.8h396.8V864zM864 665.6c0 25.6-19.2 44.8-44.8 44.8h-44.8V588.8c0-17.067-14.933-32-32-32H281.6c-17.067 0-32 14.933-32 32v121.6h-44.8c-25.6 0-44.8-19.2-44.8-44.8v-192c0-25.6 19.2-44.8 44.8-44.8h614.4c25.6 0 44.8 19.2 44.8 44.8v192z"></path></svg></button><div class="arrow end"></div></div><div class="vp-toc-wrapper"><ul class="vp-toc-list"><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level2" href="#å‰è¨€">å‰è¨€</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level2" href="#ç›®å½•">ç›®å½•</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level2" href="#threadlocalä»£ç æ¼”ç¤º">ThreadLocalä»£ç æ¼”ç¤º</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level2" href="#threadlocalçš„æ•°æ®ç»“æ„">ThreadLocalçš„æ•°æ®ç»“æ„</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level2" href="#gc-ä¹‹å-key-æ˜¯å¦ä¸º-null">GC ä¹‹å key æ˜¯å¦ä¸º nullï¼Ÿ</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level2" href="#threadlocal-set-æ–¹æ³•æºç è¯¦è§£">ThreadLocal.set()æ–¹æ³•æºç è¯¦è§£</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level2" href="#threadlocalmap-hash-ç®—æ³•">ThreadLocalMap Hash ç®—æ³•</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level2" href="#threadlocalmap-hash-å†²çª">ThreadLocalMap Hash å†²çª</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level2" href="#threadlocalmap-set-è¯¦è§£">ThreadLocalMap.set()è¯¦è§£</a></li><li><ul class="vp-toc-list"><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#threadlocalmap-set-åŸç†å›¾è§£">ThreadLocalMap.set()åŸç†å›¾è§£</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#threadlocalmap-set-æºç è¯¦è§£">ThreadLocalMap.set()æºç è¯¦è§£</a></li><!----><!--]--></ul></li><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level2" href="#threadlocalmapè¿‡æœŸ-key-çš„æ¢æµ‹å¼æ¸…ç†æµç¨‹">ThreadLocalMapè¿‡æœŸ key çš„æ¢æµ‹å¼æ¸…ç†æµç¨‹</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level2" href="#threadlocalmapæ‰©å®¹æœºåˆ¶">ThreadLocalMapæ‰©å®¹æœºåˆ¶</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level2" href="#threadlocalmap-get-è¯¦è§£">ThreadLocalMap.get()è¯¦è§£</a></li><li><ul class="vp-toc-list"><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#threadlocalmap-get-å›¾è§£">ThreadLocalMap.get()å›¾è§£</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#threadlocalmap-get-æºç è¯¦è§£">ThreadLocalMap.get()æºç è¯¦è§£</a></li><!----><!--]--></ul></li><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level2" href="#threadlocalmapè¿‡æœŸ-key-çš„å¯å‘å¼æ¸…ç†æµç¨‹">ThreadLocalMapè¿‡æœŸ key çš„å¯å‘å¼æ¸…ç†æµç¨‹</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level2" href="#inheritablethreadlocal">InheritableThreadLocal</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level2" href="#threadlocalé¡¹ç›®ä¸­ä½¿ç”¨å®æˆ˜">ThreadLocalé¡¹ç›®ä¸­ä½¿ç”¨å®æˆ˜</a></li><li><ul class="vp-toc-list"><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#threadlocalä½¿ç”¨åœºæ™¯">ThreadLocalä½¿ç”¨åœºæ™¯</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#feign-è¿œç¨‹è°ƒç”¨è§£å†³æ–¹æ¡ˆ">Feign è¿œç¨‹è°ƒç”¨è§£å†³æ–¹æ¡ˆ</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#çº¿ç¨‹æ± å¼‚æ­¥è°ƒç”¨-requestid-ä¼ é€’">çº¿ç¨‹æ± å¼‚æ­¥è°ƒç”¨ï¼ŒrequestId ä¼ é€’</a></li><!----><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level3" href="#ä½¿ç”¨-mq-å‘é€æ¶ˆæ¯ç»™ç¬¬ä¸‰æ–¹ç³»ç»Ÿ">ä½¿ç”¨ MQ å‘é€æ¶ˆæ¯ç»™ç¬¬ä¸‰æ–¹ç³»ç»Ÿ</a></li><!----><!--]--></ul></li><!--]--><!--[--><li class="vp-toc-item"><a class="route-link vp-toc-link level2" href="#ref">REF</a></li><!----><!--]--></ul><div class="vp-toc-marker" style="top:-1.7rem;"></div></div><!----></aside></div><!----><div class="theme-hope-content"><h2 id="å‰è¨€" tabindex="-1"><a class="header-anchor" href="#å‰è¨€"><span><a href="#%E5%89%8D%E8%A8%80">å‰è¨€</a></span></a></h2><p><img src="/leslie-blog/assets/1-YS5yhxvD-YS5yhxvD.png" alt=""></p><p>å¯¹äº<code>ThreadLocal</code>ï¼Œå¤§å®¶çš„ç¬¬ä¸€ååº”å¯èƒ½æ˜¯å¾ˆç®€å•å‘€ï¼Œçº¿ç¨‹çš„å˜é‡å‰¯æœ¬ï¼Œæ¯ä¸ªçº¿ç¨‹éš”ç¦»ã€‚é‚£è¿™é‡Œæœ‰å‡ ä¸ªé—®é¢˜å¤§å®¶å¯ä»¥æ€è€ƒä¸€ä¸‹ï¼š</p><ul><li><code>ThreadLocal</code>çš„ key æ˜¯<strong>å¼±å¼•ç”¨</strong>ï¼Œé‚£ä¹ˆåœ¨ <code>ThreadLocal.get()</code>çš„æ—¶å€™ï¼Œå‘ç”Ÿ<strong>GC</strong>ä¹‹åï¼Œkey æ˜¯å¦ä¸º<strong>null</strong>ï¼Ÿ</li><li><code>ThreadLocal</code>ä¸­<code>ThreadLocalMap</code>çš„<strong>æ•°æ®ç»“æ„</strong>ï¼Ÿ</li><li><code>ThreadLocalMap</code>çš„<strong>Hash ç®—æ³•</strong>ï¼Ÿ</li><li><code>ThreadLocalMap</code>ä¸­<strong>Hash å†²çª</strong>å¦‚ä½•è§£å†³ï¼Ÿ</li><li><code>ThreadLocalMap</code>çš„<strong>æ‰©å®¹æœºåˆ¶</strong>ï¼Ÿ</li><li><code>ThreadLocalMap</code>ä¸­<strong>è¿‡æœŸ key çš„æ¸…ç†æœºåˆ¶</strong>ï¼Ÿ<strong>æ¢æµ‹å¼æ¸…ç†</strong>å’Œ<strong>å¯å‘å¼æ¸…ç†</strong>æµç¨‹ï¼Ÿ</li><li><code>ThreadLocalMap.set()</code>æ–¹æ³•å®ç°åŸç†ï¼Ÿ</li><li><code>ThreadLocalMap.get()</code>æ–¹æ³•å®ç°åŸç†ï¼Ÿ</li><li>é¡¹ç›®ä¸­<code>ThreadLocal</code>ä½¿ç”¨æƒ…å†µï¼Ÿé‡åˆ°çš„å‘ï¼Ÿ</li><li>â€¦â€¦</li></ul><p>ä¸Šè¿°çš„ä¸€äº›é—®é¢˜ä½ æ˜¯å¦éƒ½å·²ç»æŒæ¡çš„å¾ˆæ¸…æ¥šäº†å‘¢ï¼Ÿæœ¬æ–‡å°†å›´ç»•è¿™äº›é—®é¢˜ä½¿ç”¨å›¾æ–‡æ–¹å¼æ¥å‰–æ<code>ThreadLocal</code>çš„<strong>ç‚¹ç‚¹æ»´æ»´</strong>ã€‚</p><h2 id="ç›®å½•" tabindex="-1"><a class="header-anchor" href="#ç›®å½•"><span><a href="#%E7%9B%AE%E5%BD%95">ç›®å½•</a></span></a></h2><p><strong>æ³¨æ˜ï¼š</strong> æœ¬æ–‡æºç åŸºäº<code>JDK 1.8</code></p><h2 id="threadlocalä»£ç æ¼”ç¤º" tabindex="-1"><a class="header-anchor" href="#threadlocalä»£ç æ¼”ç¤º"><span><a href="#threadlocal%E4%BB%A3%E7%A0%81%E6%BC%94%E7%A4%BA"><code>ThreadLocal</code>ä»£ç æ¼”ç¤º</a></span></a></h2><p>æˆ‘ä»¬å…ˆçœ‹ä¸‹<code>ThreadLocal</code>ä½¿ç”¨ç¤ºä¾‹ï¼š</p><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span>public class ThreadLocalTest {</span></span>
<span class="line"><span>    private List&lt;String&gt; messages = Lists.newArrayList();</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    public static final ThreadLocal&lt;ThreadLocalTest&gt; holder = ThreadLocal.withInitial(ThreadLocalTest::new);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    public static void add(String message) {</span></span>
<span class="line"><span>        holder.get().messages.add(message);</span></span>
<span class="line"><span>    }</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    public static List&lt;String&gt; clear() {</span></span>
<span class="line"><span>        List&lt;String&gt; messages = holder.get().messages;</span></span>
<span class="line"><span>        holder.remove();</span></span>
<span class="line"><span></span></span>
<span class="line"><span>        System.out.println(&quot;size: &quot; + holder.get().messages.size());</span></span>
<span class="line"><span>        return messages;</span></span>
<span class="line"><span>    }</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    public static void main(String[] args) {</span></span>
<span class="line"><span>        ThreadLocalTest.add(&quot;ä¸€æèŠ±ç®—ä¸ç®—æµªæ¼«&quot;);</span></span>
<span class="line"><span>        System.out.println(holder.get().messages);</span></span>
<span class="line"><span>        ThreadLocalTest.clear();</span></span>
<span class="line"><span>    }</span></span>
<span class="line"><span>}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>æ‰“å°ç»“æœï¼š</p><p><code>ThreadLocal</code>å¯¹è±¡å¯ä»¥æä¾›çº¿ç¨‹å±€éƒ¨å˜é‡ï¼Œæ¯ä¸ªçº¿ç¨‹<code>Thread</code>æ‹¥æœ‰ä¸€ä»½è‡ªå·±çš„<strong>å‰¯æœ¬å˜é‡</strong>ï¼Œå¤šä¸ªçº¿ç¨‹äº’ä¸å¹²æ‰°ã€‚</p><h2 id="threadlocalçš„æ•°æ®ç»“æ„" tabindex="-1"><a class="header-anchor" href="#threadlocalçš„æ•°æ®ç»“æ„"><span><a href="#threadlocal%E7%9A%84%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84"><code>ThreadLocal</code>çš„æ•°æ®ç»“æ„</a></span></a></h2><p><img src="/leslie-blog/assets/2-CFHd4NU8-CFHd4NU8.png" alt=""></p><p><code>Thread</code>ç±»æœ‰ä¸€ä¸ªç±»å‹ä¸º<code>ThreadLocal.ThreadLocalMap</code>çš„å®ä¾‹å˜é‡<code>threadLocals</code>ï¼Œä¹Ÿå°±æ˜¯è¯´æ¯ä¸ªçº¿ç¨‹æœ‰ä¸€ä¸ªè‡ªå·±çš„<code>ThreadLocalMap</code>ã€‚</p><p><code>ThreadLocalMap</code>æœ‰è‡ªå·±çš„ç‹¬ç«‹å®ç°ï¼Œå¯ä»¥ç®€å•åœ°å°†å®ƒçš„<code>key</code>è§†ä½œ<code>ThreadLocal</code>ï¼Œ<code>value</code>ä¸ºä»£ç ä¸­æ”¾å…¥çš„å€¼ï¼ˆå®é™…ä¸Š<code>key</code>å¹¶ä¸æ˜¯<code>ThreadLocal</code>æœ¬èº«ï¼Œè€Œæ˜¯å®ƒçš„ä¸€ä¸ª<strong>å¼±å¼•ç”¨</strong>ï¼‰ã€‚</p><p>æ¯ä¸ªçº¿ç¨‹åœ¨å¾€<code>ThreadLocal</code>é‡Œæ”¾å€¼çš„æ—¶å€™ï¼Œéƒ½ä¼šå¾€è‡ªå·±çš„<code>ThreadLocalMap</code>é‡Œå­˜ï¼Œè¯»ä¹Ÿæ˜¯ä»¥<code>ThreadLocal</code>ä½œä¸ºå¼•ç”¨ï¼Œåœ¨è‡ªå·±çš„<code>map</code>é‡Œæ‰¾å¯¹åº”çš„<code>key</code>ï¼Œä»è€Œå®ç°äº†<strong>çº¿ç¨‹éš”ç¦»</strong>ã€‚</p><p><code>ThreadLocalMap</code>æœ‰ç‚¹ç±»ä¼¼<code>HashMap</code>çš„ç»“æ„ï¼Œåªæ˜¯<code>HashMap</code>æ˜¯ç”±<strong>æ•°ç»„+é“¾è¡¨</strong>å®ç°çš„ï¼Œè€Œ<code>ThreadLocalMap</code>ä¸­å¹¶æ²¡æœ‰<strong>é“¾è¡¨</strong>ç»“æ„ã€‚</p><p>æˆ‘ä»¬è¿˜è¦æ³¨æ„<code>Entry</code>ï¼Œ å®ƒçš„<code>key</code>æ˜¯<code>ThreadLocal&lt;?&gt; k</code> ï¼Œç»§æ‰¿è‡ª<code>WeakReference</code>ï¼Œ ä¹Ÿå°±æ˜¯æˆ‘ä»¬å¸¸è¯´çš„å¼±å¼•ç”¨ç±»å‹ã€‚</p><h2 id="gc-ä¹‹å-key-æ˜¯å¦ä¸º-null" tabindex="-1"><a class="header-anchor" href="#gc-ä¹‹å-key-æ˜¯å¦ä¸º-null"><span><a href="#gc-%E4%B9%8B%E5%90%8E-key-%E6%98%AF%E5%90%A6%E4%B8%BA-null">GC ä¹‹å key æ˜¯å¦ä¸º nullï¼Ÿ</a></span></a></h2><p>å›åº”å¼€å¤´çš„é‚£ä¸ªé—®é¢˜ï¼Œ <code>ThreadLocal</code> çš„<code>key</code>æ˜¯å¼±å¼•ç”¨ï¼Œé‚£ä¹ˆåœ¨<code>ThreadLocal.get()</code>çš„æ—¶å€™ï¼Œå‘ç”Ÿ<code>GC</code>ä¹‹åï¼Œ<code>key</code>æ˜¯å¦æ˜¯<code>null</code>ï¼Ÿ</p><p>ä¸ºäº†ææ¸…æ¥šè¿™ä¸ªé—®é¢˜ï¼Œæˆ‘ä»¬éœ€è¦ææ¸…æ¥š<code>Java</code>çš„<strong>å››ç§å¼•ç”¨ç±»å‹</strong>ï¼š</p><ul><li><strong>å¼ºå¼•ç”¨</strong>ï¼šæˆ‘ä»¬å¸¸å¸¸ new å‡ºæ¥çš„å¯¹è±¡å°±æ˜¯å¼ºå¼•ç”¨ç±»å‹ï¼Œåªè¦å¼ºå¼•ç”¨å­˜åœ¨ï¼Œåƒåœ¾å›æ”¶å™¨å°†æ°¸è¿œä¸ä¼šå›æ”¶è¢«å¼•ç”¨çš„å¯¹è±¡ï¼Œå“ªæ€•å†…å­˜ä¸è¶³çš„æ—¶å€™</li><li><strong>è½¯å¼•ç”¨</strong>ï¼šä½¿ç”¨ SoftReference ä¿®é¥°çš„å¯¹è±¡è¢«ç§°ä¸ºè½¯å¼•ç”¨ï¼Œè½¯å¼•ç”¨æŒ‡å‘çš„å¯¹è±¡åœ¨å†…å­˜è¦æº¢å‡ºçš„æ—¶å€™è¢«å›æ”¶</li><li><strong>å¼±å¼•ç”¨</strong>ï¼šä½¿ç”¨ WeakReference ä¿®é¥°çš„å¯¹è±¡è¢«ç§°ä¸ºå¼±å¼•ç”¨ï¼Œåªè¦å‘ç”Ÿåƒåœ¾å›æ”¶ï¼Œè‹¥è¿™ä¸ªå¯¹è±¡åªè¢«å¼±å¼•ç”¨æŒ‡å‘ï¼Œé‚£ä¹ˆå°±ä¼šè¢«å›æ”¶</li><li><strong>è™šå¼•ç”¨</strong>ï¼šè™šå¼•ç”¨æ˜¯æœ€å¼±çš„å¼•ç”¨ï¼Œåœ¨ Java ä¸­ä½¿ç”¨ PhantomReference è¿›è¡Œå®šä¹‰ã€‚è™šå¼•ç”¨ä¸­å”¯ä¸€çš„ä½œç”¨å°±æ˜¯ç”¨é˜Ÿåˆ—æ¥æ”¶å¯¹è±¡å³å°†æ­»äº¡çš„é€šçŸ¥</li></ul><p>æ¥ç€å†æ¥çœ‹ä¸‹ä»£ç ï¼Œæˆ‘ä»¬ä½¿ç”¨åå°„çš„æ–¹å¼æ¥çœ‹çœ‹<code>GC</code>å<code>ThreadLocal</code>ä¸­çš„æ•°æ®æƒ…å†µï¼š(ä¸‹é¢ä»£ç æ¥æºè‡ªï¼š<a href="https://blog.csdn.net/thewindkee/article/details/103726942" target="_blank" rel="noopener noreferrer">https://blog.csdn.net/thewindkee/article/details/103726942</a> æœ¬åœ°è¿è¡Œæ¼”ç¤º GC å›æ”¶åœºæ™¯)</p><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span>public class ThreadLocalDemo {</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    public static void main(String[] args) throws NoSuchFieldException, IllegalAccessException, InterruptedException {</span></span>
<span class="line"><span>        Thread t = new Thread(()-&gt;test(&quot;abc&quot;,false));</span></span>
<span class="line"><span>        t.start();</span></span>
<span class="line"><span>        t.join();</span></span>
<span class="line"><span>        System.out.println(&quot;--gcå--&quot;);</span></span>
<span class="line"><span>        Thread t2 = new Thread(() -&gt; test(&quot;def&quot;, true));</span></span>
<span class="line"><span>        t2.start();</span></span>
<span class="line"><span>        t2.join();</span></span>
<span class="line"><span>    }</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    private static void test(String s,boolean isGC)  {</span></span>
<span class="line"><span>        try {</span></span>
<span class="line"><span>            new ThreadLocal&lt;&gt;().set(s);</span></span>
<span class="line"><span>            if (isGC) {</span></span>
<span class="line"><span>                System.gc();</span></span>
<span class="line"><span>            }</span></span>
<span class="line"><span>            Thread t = Thread.currentThread();</span></span>
<span class="line"><span>            Class&lt;? extends Thread&gt; clz = t.getClass();</span></span>
<span class="line"><span>            Field field = clz.getDeclaredField(&quot;threadLocals&quot;);</span></span>
<span class="line"><span>            field.setAccessible(true);</span></span>
<span class="line"><span>            Object ThreadLocalMap = field.get(t);</span></span>
<span class="line"><span>            Class&lt;?&gt; tlmClass = ThreadLocalMap.getClass();</span></span>
<span class="line"><span>            Field tableField = tlmClass.getDeclaredField(&quot;table&quot;);</span></span>
<span class="line"><span>            tableField.setAccessible(true);</span></span>
<span class="line"><span>            Object[] arr = (Object[]) tableField.get(ThreadLocalMap);</span></span>
<span class="line"><span>            for (Object o : arr) {</span></span>
<span class="line"><span>                if (o != null) {</span></span>
<span class="line"><span>                    Class&lt;?&gt; entryClass = o.getClass();</span></span>
<span class="line"><span>                    Field valueField = entryClass.getDeclaredField(&quot;value&quot;);</span></span>
<span class="line"><span>                    Field referenceField = entryClass.getSuperclass().getSuperclass().getDeclaredField(&quot;referent&quot;);</span></span>
<span class="line"><span>                    valueField.setAccessible(true);</span></span>
<span class="line"><span>                    referenceField.setAccessible(true);</span></span>
<span class="line"><span>                    System.out.println(String.format(&quot;å¼±å¼•ç”¨key:%s,å€¼:%s&quot;, referenceField.get(o), valueField.get(o)));</span></span>
<span class="line"><span>                }</span></span>
<span class="line"><span>            }</span></span>
<span class="line"><span>        } catch (Exception e) {</span></span>
<span class="line"><span>            e.printStackTrace();</span></span>
<span class="line"><span>        }</span></span>
<span class="line"><span>    }</span></span>
<span class="line"><span>}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>ç»“æœå¦‚ä¸‹ï¼š</p><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span>å¼±å¼•ç”¨key:java.lang.ThreadLocal@433619b6,å€¼:abc</span></span>
<span class="line"><span>å¼±å¼•ç”¨key:java.lang.ThreadLocal@418a15e3,å€¼:java.lang.ref.SoftReference@bf97a12</span></span>
<span class="line"><span>--gcå--</span></span>
<span class="line"><span>å¼±å¼•ç”¨key:null,å€¼:def</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><img src="/leslie-blog/assets/3-C4Apz7th-C4Apz7th.png" alt=""></p><p>å¦‚å›¾æ‰€ç¤ºï¼Œå› ä¸ºè¿™é‡Œåˆ›å»ºçš„<code>ThreadLocal</code>å¹¶æ²¡æœ‰æŒ‡å‘ä»»ä½•å€¼ï¼Œä¹Ÿå°±æ˜¯æ²¡æœ‰ä»»ä½•å¼•ç”¨ï¼š</p><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span>new ThreadLocal&lt;&gt;().set(s);</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>æ‰€ä»¥è¿™é‡Œåœ¨<code>GC</code>ä¹‹åï¼Œ<code>key</code>å°±ä¼šè¢«å›æ”¶ï¼Œæˆ‘ä»¬çœ‹åˆ°ä¸Šé¢<code>debug</code>ä¸­çš„<code>referent=null</code>, å¦‚æœ<strong>æ”¹åŠ¨ä¸€ä¸‹ä»£ç ï¼š</strong></p><p><img src="/leslie-blog/assets/4-C2eIahUh-C2eIahUh.png" alt=""></p><p>è¿™ä¸ªé—®é¢˜åˆšå¼€å§‹çœ‹ï¼Œå¦‚æœæ²¡æœ‰è¿‡å¤šæ€è€ƒï¼Œ<strong>å¼±å¼•ç”¨</strong>ï¼Œè¿˜æœ‰<strong>åƒåœ¾å›æ”¶</strong>ï¼Œé‚£ä¹ˆè‚¯å®šä¼šè§‰å¾—æ˜¯<code>null</code>ã€‚</p><p>å…¶å®æ˜¯ä¸å¯¹çš„ï¼Œå› ä¸ºé¢˜ç›®è¯´çš„æ˜¯åœ¨åš <code>ThreadLocal.get()</code> æ“ä½œï¼Œè¯æ˜å…¶å®è¿˜æ˜¯æœ‰<strong>å¼ºå¼•ç”¨</strong>å­˜åœ¨çš„ï¼Œæ‰€ä»¥ <code>key</code> å¹¶ä¸ä¸º <code>null</code>ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼Œ<code>ThreadLocal</code>çš„<strong>å¼ºå¼•ç”¨</strong>ä»ç„¶æ˜¯å­˜åœ¨çš„ã€‚</p><p><img src="/leslie-blog/assets/5-GYIVKEun-GYIVKEun.png" alt=""></p><p>å¦‚æœæˆ‘ä»¬çš„<strong>å¼ºå¼•ç”¨</strong>ä¸å­˜åœ¨çš„è¯ï¼Œé‚£ä¹ˆ <code>key</code> å°±ä¼šè¢«å›æ”¶ï¼Œä¹Ÿå°±æ˜¯ä¼šå‡ºç°æˆ‘ä»¬ <code>value</code> æ²¡è¢«å›æ”¶ï¼Œ<code>key</code> è¢«å›æ”¶ï¼Œå¯¼è‡´ <code>value</code> æ°¸è¿œå­˜åœ¨ï¼Œå‡ºç°å†…å­˜æ³„æ¼ã€‚</p><h2 id="threadlocal-set-æ–¹æ³•æºç è¯¦è§£" tabindex="-1"><a class="header-anchor" href="#threadlocal-set-æ–¹æ³•æºç è¯¦è§£"><span><a href="#threadlocal-set-%E6%96%B9%E6%B3%95%E6%BA%90%E7%A0%81%E8%AF%A6%E8%A7%A3"><code>ThreadLocal.set()</code>æ–¹æ³•æºç è¯¦è§£</a></span></a></h2><p><img src="/leslie-blog/assets/6-DAaW6e2T-DAaW6e2T.png" alt=""></p><p><code>ThreadLocal</code>ä¸­çš„<code>set</code>æ–¹æ³•åŸç†å¦‚ä¸Šå›¾æ‰€ç¤ºï¼Œå¾ˆç®€å•ï¼Œä¸»è¦æ˜¯åˆ¤æ–­<code>ThreadLocalMap</code>æ˜¯å¦å­˜åœ¨ï¼Œç„¶åä½¿ç”¨<code>ThreadLocal</code>ä¸­çš„<code>set</code>æ–¹æ³•è¿›è¡Œæ•°æ®å¤„ç†ã€‚</p><p>ä»£ç å¦‚ä¸‹ï¼š</p><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span>public void set(T value) {</span></span>
<span class="line"><span>    Thread t = Thread.currentThread();</span></span>
<span class="line"><span>    ThreadLocalMap map = getMap(t);</span></span>
<span class="line"><span>    if (map != null)</span></span>
<span class="line"><span>        map.set(this, value);</span></span>
<span class="line"><span>    else</span></span>
<span class="line"><span>        createMap(t, value);</span></span>
<span class="line"><span>}</span></span>
<span class="line"><span></span></span>
<span class="line"><span>void createMap(Thread t, T firstValue) {</span></span>
<span class="line"><span>    t.threadLocals = new ThreadLocalMap(this, firstValue);</span></span>
<span class="line"><span>}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>ä¸»è¦çš„æ ¸å¿ƒé€»è¾‘è¿˜æ˜¯åœ¨<code>ThreadLocalMap</code>ä¸­çš„ï¼Œä¸€æ­¥æ­¥å¾€ä¸‹çœ‹ï¼Œåé¢è¿˜æœ‰æ›´è¯¦ç»†çš„å‰–æã€‚</p><h2 id="threadlocalmap-hash-ç®—æ³•" tabindex="-1"><a class="header-anchor" href="#threadlocalmap-hash-ç®—æ³•"><span><a href="#threadlocalmap-hash-%E7%AE%97%E6%B3%95"><code>ThreadLocalMap</code> Hash ç®—æ³•</a></span></a></h2><p>æ—¢ç„¶æ˜¯<code>Map</code>ç»“æ„ï¼Œé‚£ä¹ˆ<code>ThreadLocalMap</code>å½“ç„¶ä¹Ÿè¦å®ç°è‡ªå·±çš„<code>hash</code>ç®—æ³•æ¥è§£å†³æ•£åˆ—è¡¨æ•°ç»„å†²çªé—®é¢˜ã€‚</p><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span>int i = key.threadLocalHashCode &amp; (len-1);</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p><code>ThreadLocalMap</code>ä¸­<code>hash</code>ç®—æ³•å¾ˆç®€å•ï¼Œè¿™é‡Œ<code>i</code>å°±æ˜¯å½“å‰ key åœ¨æ•£åˆ—è¡¨ä¸­å¯¹åº”çš„æ•°ç»„ä¸‹æ ‡ä½ç½®ã€‚</p><p>è¿™é‡Œæœ€å…³é”®çš„å°±æ˜¯<code>threadLocalHashCode</code>å€¼çš„è®¡ç®—ï¼Œ<code>ThreadLocal</code>ä¸­æœ‰ä¸€ä¸ªå±æ€§ä¸º<code>HASH_INCREMENT = 0x61c88647</code></p><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span>public class ThreadLocal&lt;T&gt; {</span></span>
<span class="line"><span>    private final int threadLocalHashCode = nextHashCode();</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    private static AtomicInteger nextHashCode = new AtomicInteger();</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    private static final int HASH_INCREMENT = 0x61c88647;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    private static int nextHashCode() {</span></span>
<span class="line"><span>        return nextHashCode.getAndAdd(HASH_INCREMENT);</span></span>
<span class="line"><span>    }</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    static class ThreadLocalMap {</span></span>
<span class="line"><span>        ThreadLocalMap(ThreadLocal&lt;?&gt; firstKey, Object firstValue) {</span></span>
<span class="line"><span>            table = new Entry[INITIAL_CAPACITY];</span></span>
<span class="line"><span>            int i = firstKey.threadLocalHashCode &amp; (INITIAL_CAPACITY - 1);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>            table[i] = new Entry(firstKey, firstValue);</span></span>
<span class="line"><span>            size = 1;</span></span>
<span class="line"><span>            setThreshold(INITIAL_CAPACITY);</span></span>
<span class="line"><span>        }</span></span>
<span class="line"><span>    }</span></span>
<span class="line"><span>}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>æ¯å½“åˆ›å»ºä¸€ä¸ª<code>ThreadLocal</code>å¯¹è±¡ï¼Œè¿™ä¸ª<code>ThreadLocal.nextHashCode</code> è¿™ä¸ªå€¼å°±ä¼šå¢é•¿ <code>0x61c88647</code> ã€‚</p><p>è¿™ä¸ªå€¼å¾ˆç‰¹æ®Šï¼Œå®ƒæ˜¯<strong>æ–æ³¢é‚£å¥‘æ•°</strong> ä¹Ÿå« <strong>é»„é‡‘åˆ†å‰²æ•°</strong>ã€‚<code>hash</code>å¢é‡ä¸º è¿™ä¸ªæ•°å­—ï¼Œå¸¦æ¥çš„å¥½å¤„å°±æ˜¯ <code>hash</code> <strong>åˆ†å¸ƒéå¸¸å‡åŒ€</strong>ã€‚</p><p>æˆ‘ä»¬è‡ªå·±å¯ä»¥å°è¯•ä¸‹ï¼š</p><p><img src="/leslie-blog/assets/8-CfIYkxc_-CfIYkxc_.png" alt=""></p><p>å¯ä»¥çœ‹åˆ°äº§ç”Ÿçš„å“ˆå¸Œç åˆ†å¸ƒå¾ˆå‡åŒ€ï¼Œè¿™é‡Œä¸å»ç»†çº <strong>æ–æ³¢é‚£å¥‘</strong>å…·ä½“ç®—æ³•ï¼Œæ„Ÿå…´è¶£çš„å¯ä»¥è‡ªè¡ŒæŸ¥é˜…ç›¸å…³èµ„æ–™ã€‚</p><h2 id="threadlocalmap-hash-å†²çª" tabindex="-1"><a class="header-anchor" href="#threadlocalmap-hash-å†²çª"><span><a href="#threadlocalmap-hash-%E5%86%B2%E7%AA%81"><code>ThreadLocalMap</code> Hash å†²çª</a></span></a></h2><blockquote><p><strong>æ³¨æ˜ï¼š</strong> ä¸‹é¢æ‰€æœ‰ç¤ºä¾‹å›¾ä¸­ï¼Œ<strong>ç»¿è‰²å—</strong><code>Entry</code>ä»£è¡¨<strong>æ­£å¸¸æ•°æ®</strong>ï¼Œ<strong>ç°è‰²å—</strong>ä»£è¡¨<code>Entry</code>çš„<code>key</code>å€¼ä¸º<code>null</code>ï¼Œ<strong>å·²è¢«åƒåœ¾å›æ”¶</strong>ã€‚<strong>ç™½è‰²å—</strong>è¡¨ç¤º<code>Entry</code>ä¸º<code>null</code>ã€‚</p></blockquote><p>è™½ç„¶<code>ThreadLocalMap</code>ä¸­ä½¿ç”¨äº†<strong>é»„é‡‘åˆ†å‰²æ•°</strong>æ¥ä½œä¸º<code>hash</code>è®¡ç®—å› å­ï¼Œå¤§å¤§å‡å°‘äº†<code>Hash</code>å†²çªçš„æ¦‚ç‡ï¼Œä½†æ˜¯ä»ç„¶ä¼šå­˜åœ¨å†²çªã€‚</p><p><code>HashMap</code>ä¸­è§£å†³å†²çªçš„æ–¹æ³•æ˜¯åœ¨æ•°ç»„ä¸Šæ„é€ ä¸€ä¸ª<strong>é“¾è¡¨</strong>ç»“æ„ï¼Œå†²çªçš„æ•°æ®æŒ‚è½½åˆ°é“¾è¡¨ä¸Šï¼Œå¦‚æœé“¾è¡¨é•¿åº¦è¶…è¿‡ä¸€å®šæ•°é‡åˆ™ä¼šè½¬åŒ–æˆ<strong>çº¢é»‘æ ‘</strong>ã€‚</p><p>è€Œ <code>ThreadLocalMap</code> ä¸­å¹¶æ²¡æœ‰é“¾è¡¨ç»“æ„ï¼Œæ‰€ä»¥è¿™é‡Œä¸èƒ½ä½¿ç”¨ <code>HashMap</code> è§£å†³å†²çªçš„æ–¹å¼äº†ã€‚</p><p><img src="/leslie-blog/assets/7-VC1KCijc-VC1KCijc.png" alt=""></p><p>å¦‚ä¸Šå›¾æ‰€ç¤ºï¼Œå¦‚æœæˆ‘ä»¬æ’å…¥ä¸€ä¸ª<code>value=27</code>çš„æ•°æ®ï¼Œé€šè¿‡ <code>hash</code> è®¡ç®—ååº”è¯¥è½å…¥æ§½ä½ 4 ä¸­ï¼Œè€Œæ§½ä½ 4 å·²ç»æœ‰äº† <code>Entry</code> æ•°æ®ã€‚</p><p>æ­¤æ—¶å°±ä¼šçº¿æ€§å‘åæŸ¥æ‰¾ï¼Œä¸€ç›´æ‰¾åˆ° <code>Entry</code> ä¸º <code>null</code> çš„æ§½ä½æ‰ä¼šåœæ­¢æŸ¥æ‰¾ï¼Œå°†å½“å‰å…ƒç´ æ”¾å…¥æ­¤æ§½ä½ä¸­ã€‚å½“ç„¶è¿­ä»£è¿‡ç¨‹ä¸­è¿˜æœ‰å…¶ä»–çš„æƒ…å†µï¼Œæ¯”å¦‚é‡åˆ°äº† <code>Entry</code> ä¸ä¸º <code>null</code> ä¸” <code>key</code> å€¼ç›¸ç­‰çš„æƒ…å†µï¼Œè¿˜æœ‰ <code>Entry</code> ä¸­çš„ <code>key</code> å€¼ä¸º <code>null</code> çš„æƒ…å†µç­‰ç­‰éƒ½ä¼šæœ‰ä¸åŒçš„å¤„ç†ï¼Œåé¢ä¼šä¸€ä¸€è¯¦ç»†è®²è§£ã€‚</p><p>è¿™é‡Œè¿˜ç”»äº†ä¸€ä¸ª<code>Entry</code>ä¸­çš„<code>key</code>ä¸º<code>null</code>çš„æ•°æ®ï¼ˆ<strong>Entry=2 çš„ç°è‰²å—æ•°æ®</strong>ï¼‰ï¼Œå› ä¸º<code>key</code>å€¼æ˜¯<strong>å¼±å¼•ç”¨</strong>ç±»å‹ï¼Œæ‰€ä»¥ä¼šæœ‰è¿™ç§æ•°æ®å­˜åœ¨ã€‚åœ¨<code>set</code>è¿‡ç¨‹ä¸­ï¼Œå¦‚æœé‡åˆ°äº†<code>key</code>è¿‡æœŸçš„<code>Entry</code>æ•°æ®ï¼Œå®é™…ä¸Šæ˜¯ä¼šè¿›è¡Œä¸€è½®<strong>æ¢æµ‹å¼æ¸…ç†</strong>æ“ä½œçš„ï¼Œå…·ä½“æ“ä½œæ–¹å¼åé¢ä¼šè®²åˆ°ã€‚</p><h2 id="threadlocalmap-set-è¯¦è§£" tabindex="-1"><a class="header-anchor" href="#threadlocalmap-set-è¯¦è§£"><span><a href="#threadlocalmap-set-%E8%AF%A6%E8%A7%A3"><code>ThreadLocalMap.set()</code>è¯¦è§£</a></span></a></h2><h3 id="threadlocalmap-set-åŸç†å›¾è§£" tabindex="-1"><a class="header-anchor" href="#threadlocalmap-set-åŸç†å›¾è§£"><span><a href="#threadlocalmap-set-%E5%8E%9F%E7%90%86%E5%9B%BE%E8%A7%A3"><code>ThreadLocalMap.set()</code>åŸç†å›¾è§£</a></span></a></h3><p>çœ‹å®Œäº†<code>ThreadLocal</code> <strong>hash ç®—æ³•</strong>åï¼Œæˆ‘ä»¬å†æ¥çœ‹<code>set</code>æ˜¯å¦‚ä½•å®ç°çš„ã€‚</p><p>å¾€<code>ThreadLocalMap</code>ä¸­<code>set</code>æ•°æ®ï¼ˆ<strong>æ–°å¢</strong>æˆ–è€…<strong>æ›´æ–°</strong>æ•°æ®ï¼‰åˆ†ä¸ºå¥½å‡ ç§æƒ…å†µï¼Œé’ˆå¯¹ä¸åŒçš„æƒ…å†µæˆ‘ä»¬ç”»å›¾æ¥è¯´æ˜ã€‚</p><p><strong>ç¬¬ä¸€ç§æƒ…å†µï¼š</strong> é€šè¿‡<code>hash</code>è®¡ç®—åçš„æ§½ä½å¯¹åº”çš„<code>Entry</code>æ•°æ®ä¸ºç©ºï¼š</p><p><img src="/leslie-blog/assets/9-DxwWV3Tg-DxwWV3Tg.png" alt=""></p><p>è¿™é‡Œç›´æ¥å°†æ•°æ®æ”¾åˆ°è¯¥æ§½ä½å³å¯ã€‚</p><p><strong>ç¬¬äºŒç§æƒ…å†µï¼š</strong> æ§½ä½æ•°æ®ä¸ä¸ºç©ºï¼Œ<code>key</code>å€¼ä¸å½“å‰<code>ThreadLocal</code>é€šè¿‡<code>hash</code>è®¡ç®—è·å–çš„<code>key</code>å€¼ä¸€è‡´ï¼š</p><p><img src="/leslie-blog/assets/10-BT_L7S9f-BT_L7S9f.png" alt=""></p><p>è¿™é‡Œç›´æ¥æ›´æ–°è¯¥æ§½ä½çš„æ•°æ®ã€‚</p><p><strong>ç¬¬ä¸‰ç§æƒ…å†µï¼š</strong> æ§½ä½æ•°æ®ä¸ä¸ºç©ºï¼Œå¾€åéå†è¿‡ç¨‹ä¸­ï¼Œåœ¨æ‰¾åˆ°<code>Entry</code>ä¸º<code>null</code>çš„æ§½ä½ä¹‹å‰ï¼Œæ²¡æœ‰é‡åˆ°<code>key</code>è¿‡æœŸçš„<code>Entry</code>ï¼š</p><p><img src="/leslie-blog/assets/11-Ctau4y8i-Ctau4y8i.png" alt=""></p><p>éå†æ•£åˆ—æ•°ç»„ï¼Œçº¿æ€§å¾€åæŸ¥æ‰¾ï¼Œå¦‚æœæ‰¾åˆ°<code>Entry</code>ä¸º<code>null</code>çš„æ§½ä½ï¼Œåˆ™å°†æ•°æ®æ”¾å…¥è¯¥æ§½ä½ä¸­ï¼Œæˆ–è€…å¾€åéå†è¿‡ç¨‹ä¸­ï¼Œé‡åˆ°äº†<strong>key å€¼ç›¸ç­‰</strong>çš„æ•°æ®ï¼Œç›´æ¥æ›´æ–°å³å¯ã€‚</p><p><strong>ç¬¬å››ç§æƒ…å†µï¼š</strong> æ§½ä½æ•°æ®ä¸ä¸ºç©ºï¼Œå¾€åéå†è¿‡ç¨‹ä¸­ï¼Œåœ¨æ‰¾åˆ°<code>Entry</code>ä¸º<code>null</code>çš„æ§½ä½ä¹‹å‰ï¼Œé‡åˆ°<code>key</code>è¿‡æœŸçš„<code>Entry</code>ï¼Œå¦‚ä¸‹å›¾ï¼Œå¾€åéå†è¿‡ç¨‹ä¸­ï¼Œé‡åˆ°äº†<code>index=7</code>çš„æ§½ä½æ•°æ®<code>Entry</code>çš„<code>key=null</code>ï¼š</p><p><img src="/leslie-blog/assets/12-CF9wKPyx-CF9wKPyx.png" alt=""></p><p>æ•£åˆ—æ•°ç»„ä¸‹æ ‡ä¸º 7 ä½ç½®å¯¹åº”çš„<code>Entry</code>æ•°æ®<code>key</code>ä¸º<code>null</code>ï¼Œè¡¨æ˜æ­¤æ•°æ®<code>key</code>å€¼å·²ç»è¢«åƒåœ¾å›æ”¶æ‰äº†ï¼Œæ­¤æ—¶å°±ä¼šæ‰§è¡Œ<code>replaceStaleEntry()</code>æ–¹æ³•ï¼Œè¯¥æ–¹æ³•å«ä¹‰æ˜¯<strong>æ›¿æ¢è¿‡æœŸæ•°æ®çš„é€»è¾‘</strong>ï¼Œä»¥<strong>index=7</strong>ä½èµ·ç‚¹å¼€å§‹éå†ï¼Œè¿›è¡Œæ¢æµ‹å¼æ•°æ®æ¸…ç†å·¥ä½œã€‚</p><p>åˆå§‹åŒ–æ¢æµ‹å¼æ¸…ç†è¿‡æœŸæ•°æ®æ‰«æçš„å¼€å§‹ä½ç½®ï¼š<code>slotToExpunge = staleSlot = 7</code></p><p>ä»¥å½“å‰<code>staleSlot</code>å¼€å§‹ å‘å‰è¿­ä»£æŸ¥æ‰¾ï¼Œæ‰¾å…¶ä»–è¿‡æœŸçš„æ•°æ®ï¼Œç„¶åæ›´æ–°è¿‡æœŸæ•°æ®èµ·å§‹æ‰«æä¸‹æ ‡<code>slotToExpunge</code>ã€‚<code>for</code>å¾ªç¯è¿­ä»£ï¼Œç›´åˆ°ç¢°åˆ°<code>Entry</code>ä¸º<code>null</code>ç»“æŸã€‚</p><p>å¦‚æœæ‰¾åˆ°äº†è¿‡æœŸçš„æ•°æ®ï¼Œç»§ç»­å‘å‰è¿­ä»£ï¼Œç›´åˆ°é‡åˆ°<code>Entry=null</code>çš„æ§½ä½æ‰åœæ­¢è¿­ä»£ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼Œ<strong>slotToExpunge è¢«æ›´æ–°ä¸º 0</strong>ï¼š</p><p><img src="/leslie-blog/assets/13-D6fzHCA3-D6fzHCA3.png" alt=""></p><p>ä»¥å½“å‰èŠ‚ç‚¹(<code>index=7</code>)å‘å‰è¿­ä»£ï¼Œæ£€æµ‹æ˜¯å¦æœ‰è¿‡æœŸçš„<code>Entry</code>æ•°æ®ï¼Œå¦‚æœæœ‰åˆ™æ›´æ–°<code>slotToExpunge</code>å€¼ã€‚ç¢°åˆ°<code>null</code>åˆ™ç»“æŸæ¢æµ‹ã€‚ä»¥ä¸Šå›¾ä¸ºä¾‹<code>slotToExpunge</code>è¢«æ›´æ–°ä¸º 0ã€‚</p><p>ä¸Šé¢å‘å‰è¿­ä»£çš„æ“ä½œæ˜¯ä¸ºäº†æ›´æ–°æ¢æµ‹æ¸…ç†è¿‡æœŸæ•°æ®çš„èµ·å§‹ä¸‹æ ‡<code>slotToExpunge</code>çš„å€¼ï¼Œè¿™ä¸ªå€¼åœ¨åé¢ä¼šè®²è§£ï¼Œå®ƒæ˜¯ç”¨æ¥åˆ¤æ–­å½“å‰è¿‡æœŸæ§½ä½<code>staleSlot</code>ä¹‹å‰æ˜¯å¦è¿˜æœ‰è¿‡æœŸå…ƒç´ ã€‚</p><p>æ¥ç€å¼€å§‹ä»¥<code>staleSlot</code>ä½ç½®(<code>index=7</code>)å‘åè¿­ä»£ï¼Œ<strong>å¦‚æœæ‰¾åˆ°äº†ç›¸åŒ key å€¼çš„ Entry æ•°æ®ï¼š</strong></p><p><img src="/leslie-blog/assets/14-JZFHVIRS-JZFHVIRS.png" alt=""></p><p>ä»å½“å‰èŠ‚ç‚¹<code>staleSlot</code>å‘åæŸ¥æ‰¾<code>key</code>å€¼ç›¸ç­‰çš„<code>Entry</code>å…ƒç´ ï¼Œæ‰¾åˆ°åæ›´æ–°<code>Entry</code>çš„å€¼å¹¶äº¤æ¢<code>staleSlot</code>å…ƒç´ çš„ä½ç½®(<code>staleSlot</code>ä½ç½®ä¸ºè¿‡æœŸå…ƒç´ )ï¼Œæ›´æ–°<code>Entry</code>æ•°æ®ï¼Œç„¶åå¼€å§‹è¿›è¡Œè¿‡æœŸ<code>Entry</code>çš„æ¸…ç†å·¥ä½œï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p><p><img src="https://oss.javaguide.cn/java-guide-blog/view.png" alt="">å‘åéå†è¿‡ç¨‹ä¸­ï¼Œå¦‚æœæ²¡æœ‰æ‰¾åˆ°ç›¸åŒ key å€¼çš„ Entry æ•°æ®ï¼š</p><p><img src="/leslie-blog/assets/15-QnD6a_OO-QnD6a_OO.png" alt=""></p><p>ä»å½“å‰èŠ‚ç‚¹<code>staleSlot</code>å‘åæŸ¥æ‰¾<code>key</code>å€¼ç›¸ç­‰çš„<code>Entry</code>å…ƒç´ ï¼Œç›´åˆ°<code>Entry</code>ä¸º<code>null</code>åˆ™åœæ­¢å¯»æ‰¾ã€‚é€šè¿‡ä¸Šå›¾å¯çŸ¥ï¼Œæ­¤æ—¶<code>table</code>ä¸­æ²¡æœ‰<code>key</code>å€¼ç›¸åŒçš„<code>Entry</code>ã€‚</p><p>åˆ›å»ºæ–°çš„<code>Entry</code>ï¼Œæ›¿æ¢<code>table[stableSlot]</code>ä½ç½®ï¼š</p><p><img src="/leslie-blog/assets/16-DY6uSTD1-DY6uSTD1.png" alt=""></p><p>æ›¿æ¢å®Œæˆåä¹Ÿæ˜¯è¿›è¡Œè¿‡æœŸå…ƒç´ æ¸…ç†å·¥ä½œï¼Œæ¸…ç†å·¥ä½œä¸»è¦æ˜¯æœ‰ä¸¤ä¸ªæ–¹æ³•ï¼š<code>expungeStaleEntry()</code>å’Œ<code>cleanSomeSlots()</code>ï¼Œå…·ä½“ç»†èŠ‚åé¢ä¼šè®²åˆ°ï¼Œè¯·ç»§ç»­å¾€åçœ‹ã€‚</p><h3 id="threadlocalmap-set-æºç è¯¦è§£" tabindex="-1"><a class="header-anchor" href="#threadlocalmap-set-æºç è¯¦è§£"><span><a href="#threadlocalmap-set-%E6%BA%90%E7%A0%81%E8%AF%A6%E8%A7%A3"><code>ThreadLocalMap.set()</code>æºç è¯¦è§£</a></span></a></h3><p>ä¸Šé¢å·²ç»ç”¨å›¾çš„æ–¹å¼è§£æäº†<code>set()</code>å®ç°çš„åŸç†ï¼Œå…¶å®å·²ç»å¾ˆæ¸…æ™°äº†ï¼Œæˆ‘ä»¬æ¥ç€å†çœ‹ä¸‹æºç ï¼š</p><p><code>java.lang.ThreadLocal</code>.<code>ThreadLocalMap.set()</code>:</p><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span>private void set(ThreadLocal&lt;?&gt; key, Object value) {</span></span>
<span class="line"><span>    Entry[] tab = table;</span></span>
<span class="line"><span>    int len = tab.length;</span></span>
<span class="line"><span>    int i = key.threadLocalHashCode &amp; (len-1);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    for (Entry e = tab[i];</span></span>
<span class="line"><span>         e != null;</span></span>
<span class="line"><span>         e = tab[i = nextIndex(i, len)]) {</span></span>
<span class="line"><span>        ThreadLocal&lt;?&gt; k = e.get();</span></span>
<span class="line"><span></span></span>
<span class="line"><span>        if (k == key) {</span></span>
<span class="line"><span>            e.value = value;</span></span>
<span class="line"><span>            return;</span></span>
<span class="line"><span>        }</span></span>
<span class="line"><span></span></span>
<span class="line"><span>        if (k == null) {</span></span>
<span class="line"><span>            replaceStaleEntry(key, value, i);</span></span>
<span class="line"><span>            return;</span></span>
<span class="line"><span>        }</span></span>
<span class="line"><span>    }</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    tab[i] = new Entry(key, value);</span></span>
<span class="line"><span>    int sz = ++size;</span></span>
<span class="line"><span>    if (!cleanSomeSlots(i, sz) &amp;&amp; sz &gt;= threshold)</span></span>
<span class="line"><span>        rehash();</span></span>
<span class="line"><span>}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>è¿™é‡Œä¼šé€šè¿‡<code>key</code>æ¥è®¡ç®—åœ¨æ•£åˆ—è¡¨ä¸­çš„å¯¹åº”ä½ç½®ï¼Œç„¶åä»¥å½“å‰<code>key</code>å¯¹åº”çš„æ¡¶çš„ä½ç½®å‘åæŸ¥æ‰¾ï¼Œæ‰¾åˆ°å¯ä»¥ä½¿ç”¨çš„æ¡¶ã€‚</p><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span>Entry[] tab = table;</span></span>
<span class="line"><span>int len = tab.length;</span></span>
<span class="line"><span>int i = key.threadLocalHashCode &amp; (len-1);</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>ä»€ä¹ˆæƒ…å†µä¸‹æ¡¶æ‰æ˜¯å¯ä»¥ä½¿ç”¨çš„å‘¢ï¼Ÿ</p><ol><li><code>k = key</code> è¯´æ˜æ˜¯æ›¿æ¢æ“ä½œï¼Œå¯ä»¥ä½¿ç”¨</li><li>ç¢°åˆ°ä¸€ä¸ªè¿‡æœŸçš„æ¡¶ï¼Œæ‰§è¡Œæ›¿æ¢é€»è¾‘ï¼Œå ç”¨è¿‡æœŸæ¡¶</li><li>æŸ¥æ‰¾è¿‡ç¨‹ä¸­ï¼Œç¢°åˆ°æ¡¶ä¸­<code>Entry=null</code>çš„æƒ…å†µï¼Œç›´æ¥ä½¿ç”¨</li></ol><p>æ¥ç€å°±æ˜¯æ‰§è¡Œ<code>for</code>å¾ªç¯éå†ï¼Œå‘åæŸ¥æ‰¾ï¼Œæˆ‘ä»¬å…ˆçœ‹ä¸‹<code>nextIndex()</code>ã€<code>prevIndex()</code>æ–¹æ³•å®ç°ï¼š</p><p><img src="/leslie-blog/assets/17-CVdaspq--CVdaspq-.png" alt=""></p><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span>private static int nextIndex(int i, int len) {</span></span>
<span class="line"><span>    return ((i + 1 &lt; len) ? i + 1 : 0);</span></span>
<span class="line"><span>}</span></span>
<span class="line"><span></span></span>
<span class="line"><span>private static int prevIndex(int i, int len) {</span></span>
<span class="line"><span>    return ((i - 1 &gt;= 0) ? i - 1 : len - 1);</span></span>
<span class="line"><span>}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>æ¥ç€çœ‹å‰©ä¸‹<code>for</code>å¾ªç¯ä¸­çš„é€»è¾‘ï¼š</p><ol><li>éå†å½“å‰<code>key</code>å€¼å¯¹åº”çš„æ¡¶ä¸­<code>Entry</code>æ•°æ®ä¸ºç©ºï¼Œè¿™è¯´æ˜æ•£åˆ—æ•°ç»„è¿™é‡Œæ²¡æœ‰æ•°æ®å†²çªï¼Œè·³å‡º<code>for</code>å¾ªç¯ï¼Œç›´æ¥<code>set</code>æ•°æ®åˆ°å¯¹åº”çš„æ¡¶ä¸­</li><li>å¦‚æœ<code>key</code>å€¼å¯¹åº”çš„æ¡¶ä¸­<code>Entry</code>æ•°æ®ä¸ä¸ºç©º<br> 2.1 å¦‚æœ<code>k = key</code>ï¼Œè¯´æ˜å½“å‰<code>set</code>æ“ä½œæ˜¯ä¸€ä¸ªæ›¿æ¢æ“ä½œï¼Œåšæ›¿æ¢é€»è¾‘ï¼Œç›´æ¥è¿”å›<br> 2.2 å¦‚æœ<code>key = null</code>ï¼Œè¯´æ˜å½“å‰æ¡¶ä½ç½®çš„<code>Entry</code>æ˜¯è¿‡æœŸæ•°æ®ï¼Œæ‰§è¡Œ<code>replaceStaleEntry()</code>æ–¹æ³•(æ ¸å¿ƒæ–¹æ³•)ï¼Œç„¶åè¿”å›</li><li><code>for</code>å¾ªç¯æ‰§è¡Œå®Œæ¯•ï¼Œç»§ç»­å¾€ä¸‹æ‰§è¡Œè¯´æ˜å‘åè¿­ä»£çš„è¿‡ç¨‹ä¸­é‡åˆ°äº†<code>entry</code>ä¸º<code>null</code>çš„æƒ…å†µ<br> 3.1 åœ¨<code>Entry</code>ä¸º<code>null</code>çš„æ¡¶ä¸­åˆ›å»ºä¸€ä¸ªæ–°çš„<code>Entry</code>å¯¹è±¡<br> 3.2 æ‰§è¡Œ<code>++size</code>æ“ä½œ</li><li>è°ƒç”¨<code>cleanSomeSlots()</code>åšä¸€æ¬¡å¯å‘å¼æ¸…ç†å·¥ä½œï¼Œæ¸…ç†æ•£åˆ—æ•°ç»„ä¸­<code>Entry</code>çš„<code>key</code>è¿‡æœŸçš„æ•°æ®<br> 4.1 å¦‚æœæ¸…ç†å·¥ä½œå®Œæˆåï¼Œæœªæ¸…ç†åˆ°ä»»ä½•æ•°æ®ï¼Œä¸”<code>size</code>è¶…è¿‡äº†é˜ˆå€¼(æ•°ç»„é•¿åº¦çš„ 2/3)ï¼Œè¿›è¡Œ<code>rehash()</code>æ“ä½œ<br> 4.2 <code>rehash()</code>ä¸­ä¼šå…ˆè¿›è¡Œä¸€è½®æ¢æµ‹å¼æ¸…ç†ï¼Œæ¸…ç†è¿‡æœŸ<code>key</code>ï¼Œæ¸…ç†å®Œæˆåå¦‚æœ<strong>size &gt;= threshold - threshold / 4</strong>ï¼Œå°±ä¼šæ‰§è¡ŒçœŸæ­£çš„æ‰©å®¹é€»è¾‘(æ‰©å®¹é€»è¾‘å¾€åçœ‹)</li></ol><p>æ¥ç€é‡ç‚¹çœ‹ä¸‹<code>replaceStaleEntry()</code>æ–¹æ³•ï¼Œ<code>replaceStaleEntry()</code>æ–¹æ³•æä¾›æ›¿æ¢è¿‡æœŸæ•°æ®çš„åŠŸèƒ½ï¼Œæˆ‘ä»¬å¯ä»¥å¯¹åº”ä¸Šé¢<strong>ç¬¬å››ç§æƒ…å†µ</strong>çš„åŸç†å›¾æ¥å†å›é¡¾ä¸‹ï¼Œå…·ä½“ä»£ç å¦‚ä¸‹ï¼š</p><p><code>java.lang.ThreadLocal.ThreadLocalMap.replaceStaleEntry()</code>:</p><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span>private void replaceStaleEntry(ThreadLocal&lt;?&gt; key, Object value,</span></span>
<span class="line"><span>                                       int staleSlot) {</span></span>
<span class="line"><span>    Entry[] tab = table;</span></span>
<span class="line"><span>    int len = tab.length;</span></span>
<span class="line"><span>    Entry e;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    int slotToExpunge = staleSlot;</span></span>
<span class="line"><span>    for (int i = prevIndex(staleSlot, len);</span></span>
<span class="line"><span>         (e = tab[i]) != null;</span></span>
<span class="line"><span>         i = prevIndex(i, len))</span></span>
<span class="line"><span></span></span>
<span class="line"><span>        if (e.get() == null)</span></span>
<span class="line"><span>            slotToExpunge = i;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    for (int i = nextIndex(staleSlot, len);</span></span>
<span class="line"><span>         (e = tab[i]) != null;</span></span>
<span class="line"><span>         i = nextIndex(i, len)) {</span></span>
<span class="line"><span></span></span>
<span class="line"><span>        ThreadLocal&lt;?&gt; k = e.get();</span></span>
<span class="line"><span></span></span>
<span class="line"><span>        if (k == key) {</span></span>
<span class="line"><span>            e.value = value;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>            tab[i] = tab[staleSlot];</span></span>
<span class="line"><span>            tab[staleSlot] = e;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>            if (slotToExpunge == staleSlot)</span></span>
<span class="line"><span>                slotToExpunge = i;</span></span>
<span class="line"><span>            cleanSomeSlots(expungeStaleEntry(slotToExpunge), len);</span></span>
<span class="line"><span>            return;</span></span>
<span class="line"><span>        }</span></span>
<span class="line"><span></span></span>
<span class="line"><span>        if (k == null &amp;&amp; slotToExpunge == staleSlot)</span></span>
<span class="line"><span>            slotToExpunge = i;</span></span>
<span class="line"><span>    }</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    tab[staleSlot].value = null;</span></span>
<span class="line"><span>    tab[staleSlot] = new Entry(key, value);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    if (slotToExpunge != staleSlot)</span></span>
<span class="line"><span>        cleanSomeSlots(expungeStaleEntry(slotToExpunge), len);</span></span>
<span class="line"><span>}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><code>slotToExpunge</code>è¡¨ç¤ºå¼€å§‹æ¢æµ‹å¼æ¸…ç†è¿‡æœŸæ•°æ®çš„å¼€å§‹ä¸‹æ ‡ï¼Œé»˜è®¤ä»å½“å‰çš„<code>staleSlot</code>å¼€å§‹ã€‚ä»¥å½“å‰çš„<code>staleSlot</code>å¼€å§‹ï¼Œå‘å‰è¿­ä»£æŸ¥æ‰¾ï¼Œæ‰¾åˆ°æ²¡æœ‰è¿‡æœŸçš„æ•°æ®ï¼Œ<code>for</code>å¾ªç¯ä¸€ç›´ç¢°åˆ°<code>Entry</code>ä¸º<code>null</code>æ‰ä¼šç»“æŸã€‚å¦‚æœå‘å‰æ‰¾åˆ°äº†è¿‡æœŸæ•°æ®ï¼Œæ›´æ–°æ¢æµ‹æ¸…ç†è¿‡æœŸæ•°æ®çš„å¼€å§‹ä¸‹æ ‡ä¸º iï¼Œå³<code>slotToExpunge=i</code></p><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span>for (int i = prevIndex(staleSlot, len);</span></span>
<span class="line"><span>     (e = tab[i]) != null;</span></span>
<span class="line"><span>     i = prevIndex(i, len)){</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    if (e.get() == null){</span></span>
<span class="line"><span>        slotToExpunge = i;</span></span>
<span class="line"><span>    }</span></span>
<span class="line"><span>}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>æ¥ç€å¼€å§‹ä»<code>staleSlot</code>å‘åæŸ¥æ‰¾ï¼Œä¹Ÿæ˜¯ç¢°åˆ°<code>Entry</code>ä¸º<code>null</code>çš„æ¡¶ç»“æŸã€‚<br> å¦‚æœè¿­ä»£è¿‡ç¨‹ä¸­ï¼Œ<strong>ç¢°åˆ° k == key</strong>ï¼Œè¿™è¯´æ˜è¿™é‡Œæ˜¯æ›¿æ¢é€»è¾‘ï¼Œæ›¿æ¢æ–°æ•°æ®å¹¶ä¸”äº¤æ¢å½“å‰<code>staleSlot</code>ä½ç½®ã€‚å¦‚æœ<code>slotToExpunge == staleSlot</code>ï¼Œè¿™è¯´æ˜<code>replaceStaleEntry()</code>ä¸€å¼€å§‹å‘å‰æŸ¥æ‰¾è¿‡æœŸæ•°æ®æ—¶å¹¶æœªæ‰¾åˆ°è¿‡æœŸçš„<code>Entry</code>æ•°æ®ï¼Œæ¥ç€å‘åæŸ¥æ‰¾è¿‡ç¨‹ä¸­ä¹Ÿæœªå‘ç°è¿‡æœŸæ•°æ®ï¼Œä¿®æ”¹å¼€å§‹æ¢æµ‹å¼æ¸…ç†è¿‡æœŸæ•°æ®çš„ä¸‹æ ‡ä¸ºå½“å‰å¾ªç¯çš„ indexï¼Œå³<code>slotToExpunge = i</code>ã€‚æœ€åè°ƒç”¨<code>cleanSomeSlots(expungeStaleEntry(slotToExpunge), len);</code>è¿›è¡Œå¯å‘å¼è¿‡æœŸæ•°æ®æ¸…ç†ã€‚</p><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span>if (k == key) {</span></span>
<span class="line"><span>    e.value = value;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    tab[i] = tab[staleSlot];</span></span>
<span class="line"><span>    tab[staleSlot] = e;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    if (slotToExpunge == staleSlot)</span></span>
<span class="line"><span>        slotToExpunge = i;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    cleanSomeSlots(expungeStaleEntry(slotToExpunge), len);</span></span>
<span class="line"><span>    return;</span></span>
<span class="line"><span>}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><code>cleanSomeSlots()</code>å’Œ<code>expungeStaleEntry()</code>æ–¹æ³•åé¢éƒ½ä¼šç»†è®²ï¼Œè¿™ä¸¤ä¸ªæ˜¯å’Œæ¸…ç†ç›¸å…³çš„æ–¹æ³•ï¼Œä¸€ä¸ªæ˜¯è¿‡æœŸ<code>key</code>ç›¸å…³<code>Entry</code>çš„å¯å‘å¼æ¸…ç†(<code>Heuristically scan</code>)ï¼Œå¦ä¸€ä¸ªæ˜¯è¿‡æœŸ<code>key</code>ç›¸å…³<code>Entry</code>çš„æ¢æµ‹å¼æ¸…ç†ã€‚</p><p><strong>å¦‚æœ k != key</strong>åˆ™ä¼šæ¥ç€å¾€ä¸‹èµ°ï¼Œ<code>k == null</code>è¯´æ˜å½“å‰éå†çš„<code>Entry</code>æ˜¯ä¸€ä¸ªè¿‡æœŸæ•°æ®ï¼Œ<code>slotToExpunge == staleSlot</code>è¯´æ˜ï¼Œä¸€å¼€å§‹çš„å‘å‰æŸ¥æ‰¾æ•°æ®å¹¶æœªæ‰¾åˆ°è¿‡æœŸçš„<code>Entry</code>ã€‚å¦‚æœæ¡ä»¶æˆç«‹ï¼Œåˆ™æ›´æ–°<code>slotToExpunge</code> ä¸ºå½“å‰ä½ç½®ï¼Œè¿™ä¸ªå‰ææ˜¯å‰é©±èŠ‚ç‚¹æ‰«ææ—¶æœªå‘ç°è¿‡æœŸæ•°æ®ã€‚</p><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span>if (k == null &amp;&amp; slotToExpunge == staleSlot)</span></span>
<span class="line"><span>    slotToExpunge = i;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><p>å¾€åè¿­ä»£çš„è¿‡ç¨‹ä¸­å¦‚æœæ²¡æœ‰æ‰¾åˆ°<code>k == key</code>çš„æ•°æ®ï¼Œä¸”ç¢°åˆ°<code>Entry</code>ä¸º<code>null</code>çš„æ•°æ®ï¼Œåˆ™ç»“æŸå½“å‰çš„è¿­ä»£æ“ä½œã€‚æ­¤æ—¶è¯´æ˜è¿™é‡Œæ˜¯ä¸€ä¸ªæ·»åŠ çš„é€»è¾‘ï¼Œå°†æ–°çš„æ•°æ®æ·»åŠ åˆ°<code>table[staleSlot]</code> å¯¹åº”çš„<code>slot</code>ä¸­ã€‚</p><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span>tab[staleSlot].value = null;</span></span>
<span class="line"><span>tab[staleSlot] = new Entry(key, value);</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><p>æœ€ååˆ¤æ–­é™¤äº†<code>staleSlot</code>ä»¥å¤–ï¼Œè¿˜å‘ç°äº†å…¶ä»–è¿‡æœŸçš„<code>slot</code>æ•°æ®ï¼Œå°±è¦å¼€å¯æ¸…ç†æ•°æ®çš„é€»è¾‘ï¼š</p><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span>if (slotToExpunge != staleSlot)</span></span>
<span class="line"><span>    cleanSomeSlots(expungeStaleEntry(slotToExpunge), len);</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="threadlocalmapè¿‡æœŸ-key-çš„æ¢æµ‹å¼æ¸…ç†æµç¨‹" tabindex="-1"><a class="header-anchor" href="#threadlocalmapè¿‡æœŸ-key-çš„æ¢æµ‹å¼æ¸…ç†æµç¨‹"><span><a href="#threadlocalmap%E8%BF%87%E6%9C%9F-key-%E7%9A%84%E6%8E%A2%E6%B5%8B%E5%BC%8F%E6%B8%85%E7%90%86%E6%B5%81%E7%A8%8B"><code>ThreadLocalMap</code>è¿‡æœŸ key çš„æ¢æµ‹å¼æ¸…ç†æµç¨‹</a></span></a></h2><p>ä¸Šé¢æˆ‘ä»¬æœ‰æåŠ<code>ThreadLocalMap</code>çš„ä¸¤ç§è¿‡æœŸ<code>key</code>æ•°æ®æ¸…ç†æ–¹å¼ï¼š<strong>æ¢æµ‹å¼æ¸…ç†</strong>å’Œ<strong>å¯å‘å¼æ¸…ç†</strong>ã€‚</p><p>æˆ‘ä»¬å…ˆè®²ä¸‹æ¢æµ‹å¼æ¸…ç†ï¼Œä¹Ÿå°±æ˜¯<code>expungeStaleEntry</code>æ–¹æ³•ï¼Œéå†æ•£åˆ—æ•°ç»„ï¼Œä»å¼€å§‹ä½ç½®å‘åæ¢æµ‹æ¸…ç†è¿‡æœŸæ•°æ®ï¼Œå°†è¿‡æœŸæ•°æ®çš„<code>Entry</code>è®¾ç½®ä¸º<code>null</code>ï¼Œæ²¿é€”ä¸­ç¢°åˆ°æœªè¿‡æœŸçš„æ•°æ®åˆ™å°†æ­¤æ•°æ®<code>rehash</code>åé‡æ–°åœ¨<code>table</code>æ•°ç»„ä¸­å®šä½ï¼Œå¦‚æœå®šä½çš„ä½ç½®å·²ç»æœ‰äº†æ•°æ®ï¼Œåˆ™ä¼šå°†æœªè¿‡æœŸçš„æ•°æ®æ”¾åˆ°æœ€é è¿‘æ­¤ä½ç½®çš„<code>Entry=null</code>çš„æ¡¶ä¸­ï¼Œä½¿<code>rehash</code>åçš„<code>Entry</code>æ•°æ®è·ç¦»æ­£ç¡®çš„æ¡¶çš„ä½ç½®æ›´è¿‘ä¸€äº›ã€‚æ“ä½œé€»è¾‘å¦‚ä¸‹ï¼š</p><p><img src="/leslie-blog/assets/18-ZS4gusY8-ZS4gusY8.png" alt=""></p><p>å¦‚ä¸Šå›¾ï¼Œ<code>set(27)</code> ç»è¿‡ hash è®¡ç®—ååº”è¯¥è½åˆ°<code>index=4</code>çš„æ¡¶ä¸­ï¼Œç”±äº<code>index=4</code>æ¡¶å·²ç»æœ‰äº†æ•°æ®ï¼Œæ‰€ä»¥å¾€åè¿­ä»£æœ€ç»ˆæ•°æ®æ”¾å…¥åˆ°<code>index=7</code>çš„æ¡¶ä¸­ï¼Œæ”¾å…¥åä¸€æ®µæ—¶é—´å<code>index=5</code>ä¸­çš„<code>Entry</code>æ•°æ®<code>key</code>å˜ä¸ºäº†<code>null</code></p><p><img src="/leslie-blog/assets/19-D1p9BNyC-D1p9BNyC.png" alt=""></p><p>å¦‚æœå†æœ‰å…¶ä»–æ•°æ®<code>set</code>åˆ°<code>map</code>ä¸­ï¼Œå°±ä¼šè§¦å‘<strong>æ¢æµ‹å¼æ¸…ç†</strong>æ“ä½œã€‚</p><p>å¦‚ä¸Šå›¾ï¼Œæ‰§è¡Œ<strong>æ¢æµ‹å¼æ¸…ç†</strong>åï¼Œ<code>index=5</code>çš„æ•°æ®è¢«æ¸…ç†æ‰ï¼Œç»§ç»­å¾€åè¿­ä»£ï¼Œåˆ°<code>index=7</code>çš„å…ƒç´ æ—¶ï¼Œç»è¿‡<code>rehash</code>åå‘ç°è¯¥å…ƒç´ æ­£ç¡®çš„<code>index=4</code>ï¼Œè€Œæ­¤ä½ç½®å·²ç»æœ‰äº†æ•°æ®ï¼Œå¾€åæŸ¥æ‰¾ç¦»<code>index=4</code>æœ€è¿‘çš„<code>Entry=null</code>çš„èŠ‚ç‚¹(åˆšè¢«æ¢æµ‹å¼æ¸…ç†æ‰çš„æ•°æ®ï¼š<code>index=5</code>)ï¼Œæ‰¾åˆ°åç§»åŠ¨<code>index= 7</code>çš„æ•°æ®åˆ°<code>index=5</code>ä¸­ï¼Œæ­¤æ—¶æ¡¶çš„ä½ç½®ç¦»æ­£ç¡®çš„ä½ç½®<code>index=4</code>æ›´è¿‘äº†ã€‚</p><p>ç»è¿‡ä¸€è½®æ¢æµ‹å¼æ¸…ç†åï¼Œ<code>key</code>è¿‡æœŸçš„æ•°æ®ä¼šè¢«æ¸…ç†æ‰ï¼Œæ²¡è¿‡æœŸçš„æ•°æ®ç»è¿‡<code>rehash</code>é‡å®šä½åæ‰€å¤„çš„æ¡¶ä½ç½®ç†è®ºä¸Šæ›´æ¥è¿‘<code>i= key.hashCode &amp; (tab.len - 1)</code>çš„ä½ç½®ã€‚è¿™ç§ä¼˜åŒ–ä¼šæé«˜æ•´ä¸ªæ•£åˆ—è¡¨æŸ¥è¯¢æ€§èƒ½ã€‚</p><p>æ¥ç€çœ‹ä¸‹<code>expungeStaleEntry()</code>å…·ä½“æµç¨‹ï¼Œæˆ‘ä»¬è¿˜æ˜¯ä»¥å…ˆåŸç†å›¾åæºç è®²è§£çš„æ–¹å¼æ¥ä¸€æ­¥æ­¥æ¢³ç†ï¼š</p><p><img src="/leslie-blog/assets/20-q5yWYMJM-q5yWYMJM.png" alt=""></p><p>æˆ‘ä»¬å‡è®¾<code>expungeStaleEntry(3)</code> æ¥è°ƒç”¨æ­¤æ–¹æ³•ï¼Œå¦‚ä¸Šå›¾æ‰€ç¤ºï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°<code>ThreadLocalMap</code>ä¸­<code>table</code>çš„æ•°æ®æƒ…å†µï¼Œæ¥ç€æ‰§è¡Œæ¸…ç†æ“ä½œï¼š</p><p><img src="/leslie-blog/assets/21-DO0JHcZB-DO0JHcZB.png" alt=""></p><p>ç¬¬ä¸€æ­¥æ˜¯æ¸…ç©ºå½“å‰<code>staleSlot</code>ä½ç½®çš„æ•°æ®ï¼Œ<code>index=3</code>ä½ç½®çš„<code>Entry</code>å˜æˆäº†<code>null</code>ã€‚ç„¶åæ¥ç€å¾€åæ¢æµ‹ï¼š</p><p><img src="/leslie-blog/assets/22-Ca7r7BKK-Ca7r7BKK.png" alt=""></p><p>æ‰§è¡Œå®Œç¬¬äºŒæ­¥åï¼Œindex=4 çš„å…ƒç´ æŒªåˆ° index=3 çš„æ§½ä½ä¸­ã€‚</p><p>ç»§ç»­å¾€åè¿­ä»£æ£€æŸ¥ï¼Œç¢°åˆ°æ­£å¸¸æ•°æ®ï¼Œè®¡ç®—è¯¥æ•°æ®ä½ç½®æ˜¯å¦åç§»ï¼Œå¦‚æœè¢«åç§»ï¼Œåˆ™é‡æ–°è®¡ç®—<code>slot</code>ä½ç½®ï¼Œç›®çš„æ˜¯è®©æ­£å¸¸æ•°æ®å°½å¯èƒ½å­˜æ”¾åœ¨æ­£ç¡®ä½ç½®æˆ–ç¦»æ­£ç¡®ä½ç½®æ›´è¿‘çš„ä½ç½®</p><p><img src="/leslie-blog/assets/23-BNnrmdW0-BNnrmdW0.png" alt=""></p><p>åœ¨å¾€åè¿­ä»£çš„è¿‡ç¨‹ä¸­ç¢°åˆ°ç©ºçš„æ§½ä½ï¼Œç»ˆæ­¢æ¢æµ‹ï¼Œè¿™æ ·ä¸€è½®æ¢æµ‹å¼æ¸…ç†å·¥ä½œå°±å®Œæˆäº†ï¼Œæ¥ç€æˆ‘ä»¬ç»§ç»­çœ‹çœ‹å…·ä½“<strong>å®ç°æºä»£ç </strong>ï¼š</p><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span>private int expungeStaleEntry(int staleSlot) {</span></span>
<span class="line"><span>    Entry[] tab = table;</span></span>
<span class="line"><span>    int len = tab.length;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    tab[staleSlot].value = null;</span></span>
<span class="line"><span>    tab[staleSlot] = null;</span></span>
<span class="line"><span>    size--;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    Entry e;</span></span>
<span class="line"><span>    int i;</span></span>
<span class="line"><span>    for (i = nextIndex(staleSlot, len);</span></span>
<span class="line"><span>         (e = tab[i]) != null;</span></span>
<span class="line"><span>         i = nextIndex(i, len)) {</span></span>
<span class="line"><span>        ThreadLocal&lt;?&gt; k = e.get();</span></span>
<span class="line"><span>        if (k == null) {</span></span>
<span class="line"><span>            e.value = null;</span></span>
<span class="line"><span>            tab[i] = null;</span></span>
<span class="line"><span>            size--;</span></span>
<span class="line"><span>        } else {</span></span>
<span class="line"><span>            int h = k.threadLocalHashCode &amp; (len - 1);</span></span>
<span class="line"><span>            if (h != i) {</span></span>
<span class="line"><span>                tab[i] = null;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>                while (tab[h] != null)</span></span>
<span class="line"><span>                    h = nextIndex(h, len);</span></span>
<span class="line"><span>                tab[h] = e;</span></span>
<span class="line"><span>            }</span></span>
<span class="line"><span>        }</span></span>
<span class="line"><span>    }</span></span>
<span class="line"><span>    return i;</span></span>
<span class="line"><span>}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>è¿™é‡Œæˆ‘ä»¬è¿˜æ˜¯ä»¥<code>staleSlot=3</code> æ¥åšç¤ºä¾‹è¯´æ˜ï¼Œé¦–å…ˆæ˜¯å°†<code>tab[staleSlot]</code>æ§½ä½çš„æ•°æ®æ¸…ç©ºï¼Œç„¶åè®¾ç½®<code>size--</code><br> æ¥ç€ä»¥<code>staleSlot</code>ä½ç½®å¾€åè¿­ä»£ï¼Œå¦‚æœé‡åˆ°<code>k==null</code>çš„è¿‡æœŸæ•°æ®ï¼Œä¹Ÿæ˜¯æ¸…ç©ºè¯¥æ§½ä½æ•°æ®ï¼Œç„¶å<code>size--</code></p><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span>ThreadLocal&lt;?&gt; k = e.get();</span></span>
<span class="line"><span></span></span>
<span class="line"><span>if (k == null) {</span></span>
<span class="line"><span>    e.value = null;</span></span>
<span class="line"><span>    tab[i] = null;</span></span>
<span class="line"><span>    size--;</span></span>
<span class="line"><span>}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>å¦‚æœ<code>key</code>æ²¡æœ‰è¿‡æœŸï¼Œé‡æ–°è®¡ç®—å½“å‰<code>key</code>çš„ä¸‹æ ‡ä½ç½®æ˜¯ä¸æ˜¯å½“å‰æ§½ä½ä¸‹æ ‡ä½ç½®ï¼Œå¦‚æœä¸æ˜¯ï¼Œé‚£ä¹ˆè¯´æ˜äº§ç”Ÿäº†<code>hash</code>å†²çªï¼Œæ­¤æ—¶ä»¥æ–°è®¡ç®—å‡ºæ¥æ­£ç¡®çš„æ§½ä½ä½ç½®å¾€åè¿­ä»£ï¼Œæ‰¾åˆ°æœ€è¿‘ä¸€ä¸ªå¯ä»¥å­˜æ”¾<code>entry</code>çš„ä½ç½®ã€‚</p><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span>int h = k.threadLocalHashCode &amp; (len - 1);</span></span>
<span class="line"><span>if (h != i) {</span></span>
<span class="line"><span>    tab[i] = null;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    while (tab[h] != null)</span></span>
<span class="line"><span>        h = nextIndex(h, len);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    tab[h] = e;</span></span>
<span class="line"><span>}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>è¿™é‡Œæ˜¯å¤„ç†æ­£å¸¸çš„äº§ç”Ÿ<code>Hash</code>å†²çªçš„æ•°æ®ï¼Œç»è¿‡è¿­ä»£åï¼Œæœ‰è¿‡<code>Hash</code>å†²çªæ•°æ®çš„<code>Entry</code>ä½ç½®ä¼šæ›´é è¿‘æ­£ç¡®ä½ç½®ï¼Œè¿™æ ·çš„è¯ï¼ŒæŸ¥è¯¢çš„æ—¶å€™ æ•ˆç‡æ‰ä¼šæ›´é«˜ã€‚</p><h2 id="threadlocalmapæ‰©å®¹æœºåˆ¶" tabindex="-1"><a class="header-anchor" href="#threadlocalmapæ‰©å®¹æœºåˆ¶"><span><a href="#threadlocalmap%E6%89%A9%E5%AE%B9%E6%9C%BA%E5%88%B6"><code>ThreadLocalMap</code>æ‰©å®¹æœºåˆ¶</a></span></a></h2><p>åœ¨<code>ThreadLocalMap.set()</code>æ–¹æ³•çš„æœ€åï¼Œå¦‚æœæ‰§è¡Œå®Œå¯å‘å¼æ¸…ç†å·¥ä½œåï¼Œæœªæ¸…ç†åˆ°ä»»ä½•æ•°æ®ï¼Œä¸”å½“å‰æ•£åˆ—æ•°ç»„ä¸­<code>Entry</code>çš„æ•°é‡å·²ç»è¾¾åˆ°äº†åˆ—è¡¨çš„æ‰©å®¹é˜ˆå€¼<code>(len*2/3)</code>ï¼Œå°±å¼€å§‹æ‰§è¡Œ<code>rehash()</code>é€»è¾‘ï¼š</p><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span>if (!cleanSomeSlots(i, sz) &amp;&amp; sz &gt;= threshold)</span></span>
<span class="line"><span>    rehash();</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><p>æ¥ç€çœ‹ä¸‹<code>rehash()</code>å…·ä½“å®ç°ï¼š</p><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span>private void rehash() {</span></span>
<span class="line"><span>    expungeStaleEntries();</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    if (size &gt;= threshold - threshold / 4)</span></span>
<span class="line"><span>        resize();</span></span>
<span class="line"><span>}</span></span>
<span class="line"><span></span></span>
<span class="line"><span>private void expungeStaleEntries() {</span></span>
<span class="line"><span>    Entry[] tab = table;</span></span>
<span class="line"><span>    int len = tab.length;</span></span>
<span class="line"><span>    for (int j = 0; j &lt; len; j++) {</span></span>
<span class="line"><span>        Entry e = tab[j];</span></span>
<span class="line"><span>        if (e != null &amp;&amp; e.get() == null)</span></span>
<span class="line"><span>            expungeStaleEntry(j);</span></span>
<span class="line"><span>    }</span></span>
<span class="line"><span>}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>è¿™é‡Œé¦–å…ˆæ˜¯ä¼šè¿›è¡Œæ¢æµ‹å¼æ¸…ç†å·¥ä½œï¼Œä»<code>table</code>çš„èµ·å§‹ä½ç½®å¾€åæ¸…ç†ï¼Œä¸Šé¢æœ‰åˆ†ææ¸…ç†çš„è¯¦ç»†æµç¨‹ã€‚æ¸…ç†å®Œæˆä¹‹åï¼Œ<code>table</code>ä¸­å¯èƒ½æœ‰ä¸€äº›<code>key</code>ä¸º<code>null</code>çš„<code>Entry</code>æ•°æ®è¢«æ¸…ç†æ‰ï¼Œæ‰€ä»¥æ­¤æ—¶é€šè¿‡åˆ¤æ–­<code>size &gt;= threshold - threshold / 4</code> ä¹Ÿå°±æ˜¯<code>size &gt;= threshold * 3/4</code> æ¥å†³å®šæ˜¯å¦æ‰©å®¹ã€‚</p><p>æˆ‘ä»¬è¿˜è®°å¾—ä¸Šé¢è¿›è¡Œ<code>rehash()</code>çš„é˜ˆå€¼æ˜¯<code>size &gt;= threshold</code>ï¼Œæ‰€ä»¥å½“é¢è¯•å®˜å¥—è·¯æˆ‘ä»¬<code>ThreadLocalMap</code>æ‰©å®¹æœºåˆ¶çš„æ—¶å€™ æˆ‘ä»¬ä¸€å®šè¦è¯´æ¸…æ¥šè¿™ä¸¤ä¸ªæ­¥éª¤ï¼š</p><p><img src="/leslie-blog/assets/24-9PXxomoR-9PXxomoR.png" alt=""></p><p>æ¥ç€çœ‹çœ‹å…·ä½“çš„<code>resize()</code>æ–¹æ³•ï¼Œä¸ºäº†æ–¹ä¾¿æ¼”ç¤ºï¼Œæˆ‘ä»¬ä»¥<code>oldTab.len=8</code>æ¥ä¸¾ä¾‹ï¼š</p><p><img src="/leslie-blog/assets/25-snGS08yD-snGS08yD.png" alt=""></p><p>æ‰©å®¹åçš„<code>tab</code>çš„å¤§å°ä¸º<code>oldLen * 2</code>ï¼Œç„¶åéå†è€çš„æ•£åˆ—è¡¨ï¼Œé‡æ–°è®¡ç®—<code>hash</code>ä½ç½®ï¼Œç„¶åæ”¾åˆ°æ–°çš„<code>tab</code>æ•°ç»„ä¸­ï¼Œå¦‚æœå‡ºç°<code>hash</code>å†²çªåˆ™å¾€åå¯»æ‰¾æœ€è¿‘çš„<code>entry</code>ä¸º<code>null</code>çš„æ§½ä½ï¼Œéå†å®Œæˆä¹‹åï¼Œ<code>oldTab</code>ä¸­æ‰€æœ‰çš„<code>entry</code>æ•°æ®éƒ½å·²ç»æ”¾å…¥åˆ°æ–°çš„<code>tab</code>ä¸­äº†ã€‚é‡æ–°è®¡ç®—<code>tab</code>ä¸‹æ¬¡æ‰©å®¹çš„<strong>é˜ˆå€¼</strong>ï¼Œå…·ä½“ä»£ç å¦‚ä¸‹ï¼š</p><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span>private void resize() {</span></span>
<span class="line"><span>    Entry[] oldTab = table;</span></span>
<span class="line"><span>    int oldLen = oldTab.length;</span></span>
<span class="line"><span>    int newLen = oldLen * 2;</span></span>
<span class="line"><span>    Entry[] newTab = new Entry[newLen];</span></span>
<span class="line"><span>    int count = 0;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    for (int j = 0; j &lt; oldLen; ++j) {</span></span>
<span class="line"><span>        Entry e = oldTab[j];</span></span>
<span class="line"><span>        if (e != null) {</span></span>
<span class="line"><span>            ThreadLocal&lt;?&gt; k = e.get();</span></span>
<span class="line"><span>            if (k == null) {</span></span>
<span class="line"><span>                e.value = null;</span></span>
<span class="line"><span>            } else {</span></span>
<span class="line"><span>                int h = k.threadLocalHashCode &amp; (newLen - 1);</span></span>
<span class="line"><span>                while (newTab[h] != null)</span></span>
<span class="line"><span>                    h = nextIndex(h, newLen);</span></span>
<span class="line"><span>                newTab[h] = e;</span></span>
<span class="line"><span>                count++;</span></span>
<span class="line"><span>            }</span></span>
<span class="line"><span>        }</span></span>
<span class="line"><span>    }</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    setThreshold(newLen);</span></span>
<span class="line"><span>    size = count;</span></span>
<span class="line"><span>    table = newTab;</span></span>
<span class="line"><span>}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="threadlocalmap-get-è¯¦è§£" tabindex="-1"><a class="header-anchor" href="#threadlocalmap-get-è¯¦è§£"><span><a href="#threadlocalmap-get-%E8%AF%A6%E8%A7%A3"><code>ThreadLocalMap.get()</code>è¯¦è§£</a></span></a></h2><p>ä¸Šé¢å·²ç»çœ‹å®Œäº†<code>set()</code>æ–¹æ³•çš„æºç ï¼Œå…¶ä¸­åŒ…æ‹¬<code>set</code>æ•°æ®ã€æ¸…ç†æ•°æ®ã€ä¼˜åŒ–æ•°æ®æ¡¶çš„ä½ç½®ç­‰æ“ä½œï¼Œæ¥ç€çœ‹çœ‹<code>get()</code>æ“ä½œçš„åŸç†ã€‚</p><h3 id="threadlocalmap-get-å›¾è§£" tabindex="-1"><a class="header-anchor" href="#threadlocalmap-get-å›¾è§£"><span><a href="#threadlocalmap-get-%E5%9B%BE%E8%A7%A3"><code>ThreadLocalMap.get()</code>å›¾è§£</a></span></a></h3><p><strong>ç¬¬ä¸€ç§æƒ…å†µï¼š</strong> é€šè¿‡æŸ¥æ‰¾<code>key</code>å€¼è®¡ç®—å‡ºæ•£åˆ—è¡¨ä¸­<code>slot</code>ä½ç½®ï¼Œç„¶åè¯¥<code>slot</code>ä½ç½®ä¸­çš„<code>Entry.key</code>å’ŒæŸ¥æ‰¾çš„<code>key</code>ä¸€è‡´ï¼Œåˆ™ç›´æ¥è¿”å›ï¼š</p><p><img src="/leslie-blog/assets/26-DO12ex-R-DO12ex-R.png" alt=""></p><p><strong>ç¬¬äºŒç§æƒ…å†µï¼š</strong> <code>slot</code>ä½ç½®ä¸­çš„<code>Entry.key</code>å’Œè¦æŸ¥æ‰¾çš„<code>key</code>ä¸ä¸€è‡´ï¼š</p><p><img src="/leslie-blog/assets/27-DGESCpsE-DGESCpsE.png" alt=""></p><p>æˆ‘ä»¬ä»¥<code>get(ThreadLocal1)</code>ä¸ºä¾‹ï¼Œé€šè¿‡<code>hash</code>è®¡ç®—åï¼Œæ­£ç¡®çš„<code>slot</code>ä½ç½®åº”è¯¥æ˜¯ 4ï¼Œè€Œ<code>index=4</code>çš„æ§½ä½å·²ç»æœ‰äº†æ•°æ®ï¼Œä¸”<code>key</code>å€¼ä¸ç­‰äº<code>ThreadLocal1</code>ï¼Œæ‰€ä»¥éœ€è¦ç»§ç»­å¾€åè¿­ä»£æŸ¥æ‰¾ã€‚</p><p>è¿­ä»£åˆ°<code>index=5</code>çš„æ•°æ®æ—¶ï¼Œæ­¤æ—¶<code>Entry.key=null</code>ï¼Œè§¦å‘ä¸€æ¬¡æ¢æµ‹å¼æ•°æ®å›æ”¶æ“ä½œï¼Œæ‰§è¡Œ<code>expungeStaleEntry()</code>æ–¹æ³•ï¼Œæ‰§è¡Œå®Œåï¼Œ<code>index 5,8</code>çš„æ•°æ®éƒ½ä¼šè¢«å›æ”¶ï¼Œè€Œ<code>index 6,7</code>çš„æ•°æ®éƒ½ä¼šå‰ç§»ã€‚<code>index 6,7</code>å‰ç§»ä¹‹åï¼Œç»§ç»­ä» <code>index=5</code> å¾€åè¿­ä»£ï¼Œäºæ˜¯å°±åœ¨ <code>index=6</code> æ‰¾åˆ°äº†<code>key</code>å€¼ç›¸ç­‰çš„<code>Entry</code>æ•°æ®ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p><p><img src="/leslie-blog/assets/28-B9Czb5XF-B9Czb5XF.png" alt=""></p><h3 id="threadlocalmap-get-æºç è¯¦è§£" tabindex="-1"><a class="header-anchor" href="#threadlocalmap-get-æºç è¯¦è§£"><span><a href="#threadlocalmap-get-%E6%BA%90%E7%A0%81%E8%AF%A6%E8%A7%A3"><code>ThreadLocalMap.get()</code>æºç è¯¦è§£</a></span></a></h3><p><code>java.lang.ThreadLocal.ThreadLocalMap.getEntry()</code>:</p><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span>private Entry getEntry(ThreadLocal&lt;?&gt; key) {</span></span>
<span class="line"><span>    int i = key.threadLocalHashCode &amp; (table.length - 1);</span></span>
<span class="line"><span>    Entry e = table[i];</span></span>
<span class="line"><span>    if (e != null &amp;&amp; e.get() == key)</span></span>
<span class="line"><span>        return e;</span></span>
<span class="line"><span>    else</span></span>
<span class="line"><span>        return getEntryAfterMiss(key, i, e);</span></span>
<span class="line"><span>}</span></span>
<span class="line"><span></span></span>
<span class="line"><span>private Entry getEntryAfterMiss(ThreadLocal&lt;?&gt; key, int i, Entry e) {</span></span>
<span class="line"><span>    Entry[] tab = table;</span></span>
<span class="line"><span>    int len = tab.length;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    while (e != null) {</span></span>
<span class="line"><span>        ThreadLocal&lt;?&gt; k = e.get();</span></span>
<span class="line"><span>        if (k == key)</span></span>
<span class="line"><span>            return e;</span></span>
<span class="line"><span>        if (k == null)</span></span>
<span class="line"><span>            expungeStaleEntry(i);</span></span>
<span class="line"><span>        else</span></span>
<span class="line"><span>            i = nextIndex(i, len);</span></span>
<span class="line"><span>        e = tab[i];</span></span>
<span class="line"><span>    }</span></span>
<span class="line"><span>    return null;</span></span>
<span class="line"><span>}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="threadlocalmapè¿‡æœŸ-key-çš„å¯å‘å¼æ¸…ç†æµç¨‹" tabindex="-1"><a class="header-anchor" href="#threadlocalmapè¿‡æœŸ-key-çš„å¯å‘å¼æ¸…ç†æµç¨‹"><span><a href="#threadlocalmap%E8%BF%87%E6%9C%9F-key-%E7%9A%84%E5%90%AF%E5%8F%91%E5%BC%8F%E6%B8%85%E7%90%86%E6%B5%81%E7%A8%8B"><code>ThreadLocalMap</code>è¿‡æœŸ key çš„å¯å‘å¼æ¸…ç†æµç¨‹</a></span></a></h2><p>ä¸Šé¢å¤šæ¬¡æåŠåˆ°<code>ThreadLocalMap</code>è¿‡æœŸ key çš„ä¸¤ç§æ¸…ç†æ–¹å¼ï¼š<strong>æ¢æµ‹å¼æ¸…ç†(expungeStaleEntry())</strong>ã€<strong>å¯å‘å¼æ¸…ç†(cleanSomeSlots())</strong></p><p>æ¢æµ‹å¼æ¸…ç†æ˜¯ä»¥å½“å‰<code>Entry</code> å¾€åæ¸…ç†ï¼Œé‡åˆ°å€¼ä¸º<code>null</code>åˆ™ç»“æŸæ¸…ç†ï¼Œå±äº<strong>çº¿æ€§æ¢æµ‹æ¸…ç†</strong>ã€‚</p><p>è€Œå¯å‘å¼æ¸…ç†è¢«ä½œè€…å®šä¹‰ä¸ºï¼š<strong>Heuristically scan some cells looking for stale entries</strong>.</p><p><img src="/leslie-blog/assets/29-D5XhN-25-D5XhN-25.png" alt=""></p><p>å…·ä½“ä»£ç å¦‚ä¸‹ï¼š</p><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span>private boolean cleanSomeSlots(int i, int n) {</span></span>
<span class="line"><span>    boolean removed = false;</span></span>
<span class="line"><span>    Entry[] tab = table;</span></span>
<span class="line"><span>    int len = tab.length;</span></span>
<span class="line"><span>    do {</span></span>
<span class="line"><span>        i = nextIndex(i, len);</span></span>
<span class="line"><span>        Entry e = tab[i];</span></span>
<span class="line"><span>        if (e != null &amp;&amp; e.get() == null) {</span></span>
<span class="line"><span>            n = len;</span></span>
<span class="line"><span>            removed = true;</span></span>
<span class="line"><span>            i = expungeStaleEntry(i);</span></span>
<span class="line"><span>        }</span></span>
<span class="line"><span>    } while ( (n &gt;&gt;&gt;= 1) != 0);</span></span>
<span class="line"><span>    return removed;</span></span>
<span class="line"><span>}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="inheritablethreadlocal" tabindex="-1"><a class="header-anchor" href="#inheritablethreadlocal"><span><a href="#inheritablethreadlocal"><code>InheritableThreadLocal</code></a></span></a></h2><p>æˆ‘ä»¬ä½¿ç”¨<code>ThreadLocal</code>çš„æ—¶å€™ï¼Œåœ¨å¼‚æ­¥åœºæ™¯ä¸‹æ˜¯æ— æ³•ç»™å­çº¿ç¨‹å…±äº«çˆ¶çº¿ç¨‹ä¸­åˆ›å»ºçš„çº¿ç¨‹å‰¯æœ¬æ•°æ®çš„ã€‚</p><p>ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼ŒJDK ä¸­è¿˜æœ‰ä¸€ä¸ª<code>InheritableThreadLocal</code>ç±»ï¼Œæˆ‘ä»¬æ¥çœ‹ä¸€ä¸ªä¾‹å­ï¼š</p><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span>public class InheritableThreadLocalDemo {</span></span>
<span class="line"><span>    public static void main(String[] args) {</span></span>
<span class="line"><span>        ThreadLocal&lt;String&gt; ThreadLocal = new ThreadLocal&lt;&gt;();</span></span>
<span class="line"><span>        ThreadLocal&lt;String&gt; inheritableThreadLocal = new InheritableThreadLocal&lt;&gt;();</span></span>
<span class="line"><span>        ThreadLocal.set(&quot;çˆ¶ç±»æ•°æ®:threadLocal&quot;);</span></span>
<span class="line"><span>        inheritableThreadLocal.set(&quot;çˆ¶ç±»æ•°æ®:inheritableThreadLocal&quot;);</span></span>
<span class="line"><span></span></span>
<span class="line"><span>        new Thread(new Runnable() {</span></span>
<span class="line"><span>            @Override</span></span>
<span class="line"><span>            public void run() {</span></span>
<span class="line"><span>                System.out.println(&quot;å­çº¿ç¨‹è·å–çˆ¶ç±»ThreadLocalæ•°æ®ï¼š&quot; + ThreadLocal.get());</span></span>
<span class="line"><span>                System.out.println(&quot;å­çº¿ç¨‹è·å–çˆ¶ç±»inheritableThreadLocalæ•°æ®ï¼š&quot; + inheritableThreadLocal.get());</span></span>
<span class="line"><span>            }</span></span>
<span class="line"><span>        }).start();</span></span>
<span class="line"><span>    }</span></span>
<span class="line"><span>}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>æ‰“å°ç»“æœï¼š</p><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span>å­çº¿ç¨‹è·å–çˆ¶ç±»ThreadLocalæ•°æ®ï¼šnull</span></span>
<span class="line"><span>å­çº¿ç¨‹è·å–çˆ¶ç±»inheritableThreadLocalæ•°æ®ï¼šçˆ¶ç±»æ•°æ®:inheritableThreadLocal</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><p>å®ç°åŸç†æ˜¯å­çº¿ç¨‹æ˜¯é€šè¿‡åœ¨çˆ¶çº¿ç¨‹ä¸­é€šè¿‡è°ƒç”¨<code>new Thread()</code>æ–¹æ³•æ¥åˆ›å»ºå­çº¿ç¨‹ï¼Œ<code>Thread#init</code>æ–¹æ³•åœ¨<code>Thread</code>çš„æ„é€ æ–¹æ³•ä¸­è¢«è°ƒç”¨ã€‚åœ¨<code>init</code>æ–¹æ³•ä¸­æ‹·è´çˆ¶çº¿ç¨‹æ•°æ®åˆ°å­çº¿ç¨‹ä¸­ï¼š</p><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span>private void init(ThreadGroup g, Runnable target, String name,</span></span>
<span class="line"><span>                      long stackSize, AccessControlContext acc,</span></span>
<span class="line"><span>                      boolean inheritThreadLocals) {</span></span>
<span class="line"><span>    if (name == null) {</span></span>
<span class="line"><span>        throw new NullPointerException(&quot;name cannot be null&quot;);</span></span>
<span class="line"><span>    }</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    if (inheritThreadLocals &amp;&amp; parent.inheritableThreadLocals != null)</span></span>
<span class="line"><span>        this.inheritableThreadLocals =</span></span>
<span class="line"><span>            ThreadLocal.createInheritedMap(parent.inheritableThreadLocals);</span></span>
<span class="line"><span>    this.stackSize = stackSize;</span></span>
<span class="line"><span>    tid = nextThreadID();</span></span>
<span class="line"><span>}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>ä½†<code>InheritableThreadLocal</code>ä»ç„¶æœ‰ç¼ºé™·ï¼Œä¸€èˆ¬æˆ‘ä»¬åšå¼‚æ­¥åŒ–å¤„ç†éƒ½æ˜¯ä½¿ç”¨çš„çº¿ç¨‹æ± ï¼Œè€Œ<code>InheritableThreadLocal</code>æ˜¯åœ¨<code>new Thread</code>ä¸­çš„<code>init()</code>æ–¹æ³•ç»™èµ‹å€¼çš„ï¼Œè€Œçº¿ç¨‹æ± æ˜¯çº¿ç¨‹å¤ç”¨çš„é€»è¾‘ï¼Œæ‰€ä»¥è¿™é‡Œä¼šå­˜åœ¨é—®é¢˜ã€‚</p><p>å½“ç„¶ï¼Œæœ‰é—®é¢˜å‡ºç°å°±ä¼šæœ‰è§£å†³é—®é¢˜çš„æ–¹æ¡ˆï¼Œé˜¿é‡Œå·´å·´å¼€æºäº†ä¸€ä¸ª<code>TransmittableThreadLocal</code>ç»„ä»¶å°±å¯ä»¥è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œè¿™é‡Œå°±ä¸å†å»¶ä¼¸ï¼Œæ„Ÿå…´è¶£çš„å¯è‡ªè¡ŒæŸ¥é˜…èµ„æ–™ã€‚</p><h2 id="threadlocalé¡¹ç›®ä¸­ä½¿ç”¨å®æˆ˜" tabindex="-1"><a class="header-anchor" href="#threadlocalé¡¹ç›®ä¸­ä½¿ç”¨å®æˆ˜"><span><a href="#threadlocal%E9%A1%B9%E7%9B%AE%E4%B8%AD%E4%BD%BF%E7%94%A8%E5%AE%9E%E6%88%98"><code>ThreadLocal</code>é¡¹ç›®ä¸­ä½¿ç”¨å®æˆ˜</a></span></a></h2><h3 id="threadlocalä½¿ç”¨åœºæ™¯" tabindex="-1"><a class="header-anchor" href="#threadlocalä½¿ç”¨åœºæ™¯"><span><a href="#threadlocal%E4%BD%BF%E7%94%A8%E5%9C%BA%E6%99%AF"><code>ThreadLocal</code>ä½¿ç”¨åœºæ™¯</a></span></a></h3><p>æˆ‘ä»¬ç°åœ¨é¡¹ç›®ä¸­æ—¥å¿—è®°å½•ç”¨çš„æ˜¯<code>ELK+Logstash</code>ï¼Œæœ€ååœ¨<code>Kibana</code>ä¸­è¿›è¡Œå±•ç¤ºå’Œæ£€ç´¢ã€‚</p><p>ç°åœ¨éƒ½æ˜¯åˆ†å¸ƒå¼ç³»ç»Ÿç»Ÿä¸€å¯¹å¤–æä¾›æœåŠ¡ï¼Œé¡¹ç›®é—´è°ƒç”¨çš„å…³ç³»å¯ä»¥é€šè¿‡ <code>traceId</code> æ¥å…³è”ï¼Œä½†æ˜¯ä¸åŒé¡¹ç›®ä¹‹é—´å¦‚ä½•ä¼ é€’ <code>traceId</code> å‘¢ï¼Ÿ</p><p>è¿™é‡Œæˆ‘ä»¬ä½¿ç”¨ <code>org.slf4j.MDC</code> æ¥å®ç°æ­¤åŠŸèƒ½ï¼Œå†…éƒ¨å°±æ˜¯é€šè¿‡ <code>ThreadLocal</code> æ¥å®ç°çš„ï¼Œå…·ä½“å®ç°å¦‚ä¸‹ï¼š</p><p>å½“å‰ç«¯å‘é€è¯·æ±‚åˆ°<strong>æœåŠ¡ A</strong>æ—¶ï¼Œ<strong>æœåŠ¡ A</strong>ä¼šç”Ÿæˆä¸€ä¸ªç±»ä¼¼<code>UUID</code>çš„<code>traceId</code>å­—ç¬¦ä¸²ï¼Œå°†æ­¤å­—ç¬¦ä¸²æ”¾å…¥å½“å‰çº¿ç¨‹çš„<code>ThreadLocal</code>ä¸­ï¼Œåœ¨è°ƒç”¨<strong>æœåŠ¡ B</strong>çš„æ—¶å€™ï¼Œå°†<code>traceId</code>å†™å…¥åˆ°è¯·æ±‚çš„<code>Header</code>ä¸­ï¼Œ<strong>æœåŠ¡ B</strong>åœ¨æ¥æ”¶è¯·æ±‚æ—¶ä¼šå…ˆåˆ¤æ–­è¯·æ±‚çš„<code>Header</code>ä¸­æ˜¯å¦æœ‰<code>traceId</code>ï¼Œå¦‚æœå­˜åœ¨åˆ™å†™å…¥è‡ªå·±çº¿ç¨‹çš„<code>ThreadLocal</code>ä¸­ã€‚</p><p><img src="/leslie-blog/assets/30-uqDHaYTT-uqDHaYTT.png" alt=""></p><p>å›¾ä¸­çš„<code>requestId</code>å³ä¸ºæˆ‘ä»¬å„ä¸ªç³»ç»Ÿé“¾è·¯å…³è”çš„<code>traceId</code>ï¼Œç³»ç»Ÿé—´äº’ç›¸è°ƒç”¨ï¼Œé€šè¿‡è¿™ä¸ª<code>requestId</code>å³å¯æ‰¾åˆ°å¯¹åº”é“¾è·¯ï¼Œè¿™é‡Œè¿˜æœ‰ä¼šæœ‰ä¸€äº›å…¶ä»–åœºæ™¯ï¼š</p><p><img src="/leslie-blog/assets/31-C-bmEzk9-C-bmEzk9.png" alt=""></p><p>é’ˆå¯¹äºè¿™äº›åœºæ™¯ï¼Œæˆ‘ä»¬éƒ½å¯ä»¥æœ‰ç›¸åº”çš„è§£å†³æ–¹æ¡ˆï¼Œå¦‚ä¸‹æ‰€ç¤º</p><h3 id="feign-è¿œç¨‹è°ƒç”¨è§£å†³æ–¹æ¡ˆ" tabindex="-1"><a class="header-anchor" href="#feign-è¿œç¨‹è°ƒç”¨è§£å†³æ–¹æ¡ˆ"><span><a href="#feign-%E8%BF%9C%E7%A8%8B%E8%B0%83%E7%94%A8%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88">Feign è¿œç¨‹è°ƒç”¨è§£å†³æ–¹æ¡ˆ</a></span></a></h3><p><strong>æœåŠ¡å‘é€è¯·æ±‚ï¼š</strong></p><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span>@Component</span></span>
<span class="line"><span>@Slf4j</span></span>
<span class="line"><span>public class FeignInvokeInterceptor implements RequestInterceptor {</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    @Override</span></span>
<span class="line"><span>    public void apply(RequestTemplate template) {</span></span>
<span class="line"><span>        String requestId = MDC.get(&quot;requestId&quot;);</span></span>
<span class="line"><span>        if (StringUtils.isNotBlank(requestId)) {</span></span>
<span class="line"><span>            template.header(&quot;requestId&quot;, requestId);</span></span>
<span class="line"><span>        }</span></span>
<span class="line"><span>    }</span></span>
<span class="line"><span>}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>æœåŠ¡æ¥æ”¶è¯·æ±‚ï¼š</strong></p><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span>@Slf4j</span></span>
<span class="line"><span>@Component</span></span>
<span class="line"><span>public class LogInterceptor extends HandlerInterceptorAdapter {</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    @Override</span></span>
<span class="line"><span>    public void afterCompletion(HttpServletRequest arg0, HttpServletResponse arg1, Object arg2, Exception arg3) {</span></span>
<span class="line"><span>        MDC.remove(&quot;requestId&quot;);</span></span>
<span class="line"><span>    }</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    @Override</span></span>
<span class="line"><span>    public void postHandle(HttpServletRequest arg0, HttpServletResponse arg1, Object arg2, ModelAndView arg3) {</span></span>
<span class="line"><span>    }</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    @Override</span></span>
<span class="line"><span>    public boolean preHandle(HttpServletRequest request, HttpServletResponse response, Object handler) throws Exception {</span></span>
<span class="line"><span></span></span>
<span class="line"><span>        String requestId = request.getHeader(BaseConstant.REQUEST_ID_KEY);</span></span>
<span class="line"><span>        if (StringUtils.isBlank(requestId)) {</span></span>
<span class="line"><span>            requestId = UUID.randomUUID().toString().replace(&quot;-&quot;, &quot;&quot;);</span></span>
<span class="line"><span>        }</span></span>
<span class="line"><span>        MDC.put(&quot;requestId&quot;, requestId);</span></span>
<span class="line"><span>        return true;</span></span>
<span class="line"><span>    }</span></span>
<span class="line"><span>}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="çº¿ç¨‹æ± å¼‚æ­¥è°ƒç”¨-requestid-ä¼ é€’" tabindex="-1"><a class="header-anchor" href="#çº¿ç¨‹æ± å¼‚æ­¥è°ƒç”¨-requestid-ä¼ é€’"><span><a href="#%E7%BA%BF%E7%A8%8B%E6%B1%A0%E5%BC%82%E6%AD%A5%E8%B0%83%E7%94%A8-requestid-%E4%BC%A0%E9%80%92">çº¿ç¨‹æ± å¼‚æ­¥è°ƒç”¨ï¼ŒrequestId ä¼ é€’</a></span></a></h3><p>å› ä¸º<code>MDC</code>æ˜¯åŸºäº<code>ThreadLocal</code>å»å®ç°çš„ï¼Œå¼‚æ­¥è¿‡ç¨‹ä¸­ï¼Œå­çº¿ç¨‹å¹¶æ²¡æœ‰åŠæ³•è·å–åˆ°çˆ¶çº¿ç¨‹<code>ThreadLocal</code>å­˜å‚¨çš„æ•°æ®ï¼Œæ‰€ä»¥è¿™é‡Œå¯ä»¥è‡ªå®šä¹‰çº¿ç¨‹æ± æ‰§è¡Œå™¨ï¼Œä¿®æ”¹å…¶ä¸­çš„<code>run()</code>æ–¹æ³•ï¼š</p><div class="language- line-numbers-mode" data-highlighter="shiki" data-ext="" data-title="" style="--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span>public class MyThreadPoolTaskExecutor extends ThreadPoolTaskExecutor {</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    @Override</span></span>
<span class="line"><span>    public void execute(Runnable runnable) {</span></span>
<span class="line"><span>        Map&lt;String, String&gt; context = MDC.getCopyOfContextMap();</span></span>
<span class="line"><span>        super.execute(() -&gt; run(runnable, context));</span></span>
<span class="line"><span>    }</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    @Override</span></span>
<span class="line"><span>    private void run(Runnable runnable, Map&lt;String, String&gt; context) {</span></span>
<span class="line"><span>        if (context != null) {</span></span>
<span class="line"><span>            MDC.setContextMap(context);</span></span>
<span class="line"><span>        }</span></span>
<span class="line"><span>        try {</span></span>
<span class="line"><span>            runnable.run();</span></span>
<span class="line"><span>        } finally {</span></span>
<span class="line"><span>            MDC.remove();</span></span>
<span class="line"><span>        }</span></span>
<span class="line"><span>    }</span></span>
<span class="line"><span>}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="ä½¿ç”¨-mq-å‘é€æ¶ˆæ¯ç»™ç¬¬ä¸‰æ–¹ç³»ç»Ÿ" tabindex="-1"><a class="header-anchor" href="#ä½¿ç”¨-mq-å‘é€æ¶ˆæ¯ç»™ç¬¬ä¸‰æ–¹ç³»ç»Ÿ"><span><a href="#%E4%BD%BF%E7%94%A8-mq-%E5%8F%91%E9%80%81%E6%B6%88%E6%81%AF%E7%BB%99%E7%AC%AC%E4%B8%89%E6%96%B9%E7%B3%BB%E7%BB%9F">ä½¿ç”¨ MQ å‘é€æ¶ˆæ¯ç»™ç¬¬ä¸‰æ–¹ç³»ç»Ÿ</a></span></a></h3><p>åœ¨ MQ å‘é€çš„æ¶ˆæ¯ä½“ä¸­è‡ªå®šä¹‰å±æ€§<code>requestId</code>ï¼Œæ¥æ”¶æ–¹æ¶ˆè´¹æ¶ˆæ¯åï¼Œè‡ªå·±è§£æ<code>requestId</code>ä½¿ç”¨å³å¯ã€‚</p><h2 id="ref" tabindex="-1"><a class="header-anchor" href="#ref"><span>REF</span></a></h2><p>åŸæ–‡åœ°å€ï¼š<a href="https://juejin.cn/post/6844904151567040519" target="_blank" rel="noopener noreferrer">é¢è¯•å®˜ï¼šå°ä¼™å­ï¼Œå¬è¯´ä½ çœ‹è¿‡ThreadLocalæºç ï¼Ÿï¼ˆä¸‡å­—å›¾æ–‡æ·±åº¦è§£æThreadLocalï¼‰</a></p></div><!----><footer class="vp-page-meta"><!----><div class="vp-meta-item git-info"><div class="update-time"><span class="vp-meta-label">ä¸Šæ¬¡ç¼–è¾‘äº: </span><!----></div><div class="contributors"><span class="vp-meta-label">è´¡çŒ®è€…: </span><!--[--><!--[--><span class="vp-meta-info" title="email: LeslieDYF@gmail.com">Leslie</span><!--]--><!--]--></div></div></footer><nav class="vp-page-nav"><a class="route-link auto-link prev" href="/leslie-blog/java/concurrency/ThreadLocal.html" aria-label="ThreadLocal è¯¦è§£"><div class="hint"><span class="arrow start"></span>ä¸Šä¸€é¡µ</div><div class="link"><!---->ThreadLocal è¯¦è§£</div></a><!----></nav><div id="vp-comment" class="giscus-wrapper input-top" style="display:none;"><svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" preserveAspectRatio="xMidYMid" viewBox="0 0 100 100"><circle cx="28" cy="75" r="11" fill="currentColor"><animate attributeName="fill-opacity" begin="0s" dur="1s" keyTimes="0;0.2;1" repeatCount="indefinite" values="0;1;1"></animate></circle><path fill="none" stroke="#88baf0" stroke-width="10" d="M28 47a28 28 0 0 1 28 28"><animate attributeName="stroke-opacity" begin="0.1s" dur="1s" keyTimes="0;0.2;1" repeatCount="indefinite" values="0;1;1"></animate></path><path fill="none" stroke="#88baf0" stroke-width="10" d="M28 25a50 50 0 0 1 50 50"><animate attributeName="stroke-opacity" begin="0.2s" dur="1s" keyTimes="0;0.2;1" repeatCount="indefinite" values="0;1;1"></animate></path></svg></div><!----><!--]--></main><!--]--><footer class="vp-footer-wrapper"><div class="vp-footer">é»˜è®¤é¡µè„š</div><div class="vp-copyright">Copyright Â© 2025 Evan </div></footer></div><!--]--><!--[--><!----><!--]--><!--]--></div>
    <script type="module" src="/leslie-blog/assets/app-C4IA4XLb.js" defer></script>
  </body>
</html>
