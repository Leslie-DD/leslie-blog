import{_ as i}from"./plugin-vue_export-helper-DlAUqK2U.js";import{c as s,o as a,a as l}from"./app-BBJ6371v.js";const e="/leslie-blog/assets/ThreadLocal_1-D24WhDpp.png",n={},h=l(`<blockquote><p>å¾ˆå¤šï¼ˆæˆ‘å°±ç›´æ¥ä»£è¡¨å¾ˆå¤šäººäº†ğŸ¶ï¼‰åš Android çš„åŒå­¦è®¤è¯†å’Œå­¦ä¹  ThreadLocal éƒ½æ˜¯é€šè¿‡ Looper ä¸­çš„ sThreadLocal è¿™ä¸ªé™æ€å˜é‡å¼€å§‹çš„ï¼Œç„¶åå°±ä¼šè¿›å…¥ä¸€ä¸ªè¯¯åŒºï¼šsThreadLocal æ˜¯ Looper ä¸­çš„ä¸€ä¸ªé™æ€å˜é‡å•Šï¼Œå½“ <code>Looper#prepare(boolean quitAllowed)</code> æ–¹æ³•è°ƒç”¨ <code>sThreadLocal.set(new Looper(quitAllowed))</code> çš„æ—¶å€™å­˜åˆ° ThreadLocalMap ä¸­çš„ value (Looper) çš„ key å€¼ç«Ÿç„¶æ˜¯ thisï¼Œä¹Ÿå°±æ˜¯ sThreadLocal è¿™ä¸ªé™æ€å˜é‡ï¼Ÿé‚£ä¸€ä¸ªé™æ€å˜é‡æ€ä¹ˆèƒ½ä½œä¸º keyå€¼å‘¢ï¼Ÿé™æ€å˜é‡åœ¨è¿™ä¸ªè¿›ç¨‹ä¸­å¯æ˜¯ç‹¬ä¸€ä»½å•Šï¼Œå…¶ä»–çº¿ç¨‹çš„ Looper å†è°ƒç”¨ Looper#prepare(boolean quitAllowed) çš„æ—¶å€™å²‚ä¸ä¼šæŠŠä¹‹å‰çš„ Looper ç»™æ›¿ä»£äº†ï¼Ÿ</p></blockquote><p>è¿™èŠ‚ä¸è®²ç»†èŠ‚ï¼Œè®²æ€æƒ³ï¼Œè®²çº¿ç¨‹ç§æœ‰æ•°æ®å­˜å‚¨çš„æ€æƒ³ã€‚ä¸‹é¢å¬æˆ‘æ…¢æ…¢é“æ¥ï½</p><h2 id="threadlocal-æ˜¯æ€ä¹ˆå­˜æ•°æ®çš„" tabindex="-1"><a class="header-anchor" href="#threadlocal-æ˜¯æ€ä¹ˆå­˜æ•°æ®çš„"><span>ThreadLocal æ˜¯æ€ä¹ˆå­˜æ•°æ®çš„ï¼Ÿ</span></a></h2><blockquote><p>æˆ‘ä»¬éƒ½çŸ¥é“ ThreadLocal å®ç°äº†çº¿ç¨‹ç§æœ‰æ•°æ®çš„å­˜å‚¨ã€‚é‚£ä¹ˆï¼ŒThreadLocal åˆ°åº•æ˜¯æ€ä¹ˆå­˜å‚¨æ•°æ®çš„ï¼Ÿæˆ–è€…è¯´ï¼ŒThreadLocal æ˜¯ä½œä¸ºä¸€ä¸ªå­˜å‚¨æ•°æ®çš„æ•°æ®ç»“æ„å­˜åœ¨çš„å—ï¼Ÿ</p></blockquote><p>æ˜¾ç„¶ä¸æ˜¯ï¼ŒçœŸæ­£å­˜å‚¨æ•°æ®çš„æ˜¯ ThreadLocal çš„é™æ€å†…éƒ¨ç±» ThreadLocal.ThreadLocalMapã€‚è§‚å…¶åè€ŒçŸ¥å…¶æ„ï¼ŒThreadLocalMap æ˜¯ä¸€ä¸ª mapï¼Œmap æ˜¯ä¸€ä¸ªä»€ä¹ˆç»“æ„ï¼Ÿå½“ç„¶æ˜¯ key-value å½¢å¼çš„ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œç°åœ¨æˆ‘ä»¬ä¸éœ€è¦äº†è§£ ThreadLocalMap çš„å…·ä½“å®ç°æ–¹å¼ï¼Œæˆ‘ä»¬åªéœ€è¦çŸ¥é“ä»–æ˜¯ä¸€ä¸ª key-value å½¢å¼ä¿å­˜æ•°æ®çš„ä¸€ä¸ª map ç»“æ„å°±å¤Ÿäº†ã€‚</p><h2 id="threadlocal-å­˜åœ¨çš„æ„ä¹‰æ˜¯ä»€ä¹ˆ" tabindex="-1"><a class="header-anchor" href="#threadlocal-å­˜åœ¨çš„æ„ä¹‰æ˜¯ä»€ä¹ˆ"><span>ThreadLocal å­˜åœ¨çš„æ„ä¹‰æ˜¯ä»€ä¹ˆï¼Ÿ</span></a></h2><blockquote><p>æˆ‘ä»¬çŸ¥é“äº†çœŸæ­£ä¿å­˜æ•°æ®çš„æ˜¯ä¿å­˜åœ¨ ThreadLocalMap é‡Œçš„ï¼Œé‚£ ThreadLocal åˆæœ‰ä»€ä¹ˆä½œç”¨ï¼Ÿ</p></blockquote><p>ç®€å•æ¥è¯´ï¼ŒThreadLocal ä¸»è¦æ˜¯ä¸ºäº†å°è£… ThreadLocalMapï¼Œå¯¹å¤–æä¾› set()ã€get() æ–¹æ³•ï¼Œè®©å¼€å‘è€…å¯ä»¥æ–¹ä¾¿åœ°å­˜å–çº¿ç¨‹æœ¬åœ°å˜é‡ï¼Œè€Œæ— éœ€ç›´æ¥æ“ä½œåº•å±‚çš„ ThreadLocalMapã€‚ç¤ºä¾‹ï¼š</p><div class="language-java line-numbers-mode" data-highlighter="shiki" data-ext="java" data-title="java" style="--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E5C07B;">ThreadLocal</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">&lt;</span><span style="--shiki-light:#D73A49;--shiki-dark:#E5C07B;">String</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E06C75;"> threadLocal </span><span style="--shiki-light:#D73A49;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;"> new</span><span style="--shiki-light:#24292E;--shiki-dark:#E5C07B;"> ThreadLocal</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">&lt;&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E06C75;">()</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E5C07B;">threadLocal</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">set</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">&quot;Hello&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">);</span><span style="--shiki-light:#6A737D;--shiki-dark:#7F848E;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic;">  // æ•°æ®å®é™…å­˜å‚¨åœ¨å½“å‰çº¿ç¨‹çš„ ThreadLocalMap é‡Œ</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E5C07B;">String</span><span style="--shiki-light:#24292E;--shiki-dark:#E06C75;"> value </span><span style="--shiki-light:#D73A49;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E5C07B;"> threadLocal</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">get</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">();</span><span style="--shiki-light:#6A737D;--shiki-dark:#7F848E;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic;">  // ä»å½“å‰çº¿ç¨‹çš„ ThreadLocalMap å–å‡ºæ•°æ®</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>å¦‚æœæ²¡æœ‰ ThreadLocalï¼Œå¼€å‘è€…éœ€è¦æ‰‹åŠ¨ç»´æŠ¤ ThreadLocalMapï¼Œä»£ç ä¼šå˜å¾—å¤æ‚ï¼š</p><div class="language-java line-numbers-mode" data-highlighter="shiki" data-ext="java" data-title="java" style="--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E5C07B;">Thread</span><span style="--shiki-light:#24292E;--shiki-dark:#E06C75;"> currentThread </span><span style="--shiki-light:#D73A49;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E5C07B;"> Thread</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">currentThread</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">();</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E5C07B;">ThreadLocalMap</span><span style="--shiki-light:#24292E;--shiki-dark:#E06C75;"> map </span><span style="--shiki-light:#D73A49;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E5C07B;"> currentThread</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#24292E;--shiki-dark:#E5C07B;">threadLocals</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">;</span><span style="--shiki-light:#6A737D;--shiki-dark:#7F848E;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic;"> // å‡è®¾å¯ä»¥ç›´æ¥è®¿é—®</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E5C07B;">map</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">set</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#E5C07B;">this</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">, </span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">&quot;Hello&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">);</span><span style="--shiki-light:#6A737D;--shiki-dark:#7F848E;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic;"> // this æŒ‡ ThreadLocal å®ä¾‹</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E5C07B;">String</span><span style="--shiki-light:#24292E;--shiki-dark:#E06C75;"> value </span><span style="--shiki-light:#D73A49;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E06C75;"> (String) </span><span style="--shiki-light:#24292E;--shiki-dark:#E5C07B;">map</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">get</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#E5C07B;">this</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">);</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>ThreadLocal éšè—äº†è¿™äº›åº•å±‚ç»†èŠ‚ï¼Œæä¾›æ›´å‹å¥½çš„ APIã€‚</p><h2 id="threadlocal-threadlocalmap-æ€ä¹ˆå®ç°çº¿ç¨‹éš”ç¦»çš„" tabindex="-1"><a class="header-anchor" href="#threadlocal-threadlocalmap-æ€ä¹ˆå®ç°çº¿ç¨‹éš”ç¦»çš„"><span>ThreadLocal/ThreadLocalMap æ€ä¹ˆå®ç°çº¿ç¨‹éš”ç¦»çš„</span></a></h2><h3 id="_1-thread-å’Œ-threadlocalmap-çš„å…³ç³»" tabindex="-1"><a class="header-anchor" href="#_1-thread-å’Œ-threadlocalmap-çš„å…³ç³»"><span>1. Thread å’Œ ThreadLocalMap çš„å…³ç³»</span></a></h3><blockquote><p>éƒ½è¯´ ThreadLocal èƒ½å¤Ÿå®ç°çº¿ç¨‹ç§æœ‰æ•°æ®çš„å­˜å‚¨ï¼Œé‚£ä¹ˆä»–åˆ°åº•æ˜¯æ€ä¹ˆå®ç°çš„ï¼Ÿ</p></blockquote><p>é¦–å…ˆæˆ‘ä»¬è¦æ˜ç™½ä¸€ç‚¹ï¼Œ<code>çœŸæ­£å­˜å‚¨æ•°æ®çš„ ThreadLocalMap æ˜¯ä½œä¸º Thread çš„ä¸€ä¸ªæˆå‘˜å˜é‡å­˜åœ¨çš„ã€‚</code><br> æ¥è®©æˆ‘ä»¬çœ‹çœ‹ <code>Thread</code> çš„æºç ï¼š</p><div class="language-java line-numbers-mode" data-highlighter="shiki" data-ext="java" data-title="java" style="--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">public</span><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;"> class</span><span style="--shiki-light:#6F42C1;--shiki-dark:#E5C07B;"> Thread</span><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;"> implements</span><span style="--shiki-light:#6F42C1;--shiki-dark:#E5C07B;"> Runnable</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;"> {</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">    ...</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#7F848E;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic;">    /* ThreadLocal values pertaining to this thread. This map is maintained</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#7F848E;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic;">     * by the ThreadLocal class. */</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E5C07B;">    ThreadLocal</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#24292E;--shiki-dark:#E5C07B;">ThreadLocalMap</span><span style="--shiki-light:#24292E;--shiki-dark:#E06C75;"> threadLocals </span><span style="--shiki-light:#D73A49;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> null</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E06C75;">    </span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">    ...</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#7F848E;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic;">    /**</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#7F848E;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic;">     * This method is called by the system to give a Thread</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#7F848E;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic;">     * a chance to clean up before it actually exits.</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#7F848E;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic;">     */</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">    private</span><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;"> void</span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;"> exit</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">()</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;"> {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">        if</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;"> (group </span><span style="--shiki-light:#D73A49;--shiki-dark:#56B6C2;">!=</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> null</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">) {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E5C07B;">            group</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">threadTerminated</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#E5C07B;">this</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">            group </span><span style="--shiki-light:#D73A49;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> null</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">        }</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#7F848E;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic;">        /* Aggressively null out all reference fields: see bug 4006245 */</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">        target </span><span style="--shiki-light:#D73A49;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> null</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#7F848E;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic;">        /* Speed the release of some of these resources */</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">        threadLocals </span><span style="--shiki-light:#D73A49;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> null</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">        inheritableThreadLocals </span><span style="--shiki-light:#D73A49;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> null</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">        inheritedAccessControlContext </span><span style="--shiki-light:#D73A49;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> null</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">        blocker </span><span style="--shiki-light:#D73A49;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> null</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">        uncaughtExceptionHandler </span><span style="--shiki-light:#D73A49;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> null</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">    }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>Thread å°±æ˜¯çº¿ç¨‹ï¼Œé‚£å°±å¾ˆå®¹æ˜“ç†è§£äº†ï¼Œä¸€ä¸ª Thread éƒ½å¯ä»¥å¸¦ä¸€ä¸ª ThreadLocalMap å˜é‡ã€‚è€Œä¸”åœ¨ <code>Thread#exit()</code> æ–¹æ³•ä¸­ï¼ŒthreadLocals ä¹Ÿä¼šè¢«ç½®ç©ºã€‚æ‰€ä»¥è¯´ï¼ŒThreadLocalMap å­˜å‚¨çš„æ•°æ®çš„ç”Ÿå‘½å‘¨æœŸè·Ÿ Thread çš„ç”Ÿå‘½å‘¨æœŸæ˜¯åŒæ­¥çš„ã€‚</p><h3 id="_2-æ³›å‹åœ¨-threadlocal-ä¸­çš„åº”ç”¨ã€‚" tabindex="-1"><a class="header-anchor" href="#_2-æ³›å‹åœ¨-threadlocal-ä¸­çš„åº”ç”¨ã€‚"><span>2. æ³›å‹åœ¨ ThreadLocal ä¸­çš„åº”ç”¨ã€‚</span></a></h3><div class="language-java line-numbers-mode" data-highlighter="shiki" data-ext="java" data-title="java" style="--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">public</span><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;"> class</span><span style="--shiki-light:#6F42C1;--shiki-dark:#E5C07B;"> ThreadLocal</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">&lt;</span><span style="--shiki-light:#D73A49;--shiki-dark:#E5C07B;">T</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;"> {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">    ...</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>ThreadLocal æ˜¯ä¸€ä¸ªæ³›å‹ç±»ï¼ŒT ä»£è¡¨çš„å°±æ˜¯ Value çš„ç±»å‹ã€‚</p><div class="language-java line-numbers-mode" data-highlighter="shiki" data-ext="java" data-title="java" style="--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">static</span><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;"> class</span><span style="--shiki-light:#6F42C1;--shiki-dark:#E5C07B;"> ThreadLocalMap</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;"> {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">    ...</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>è€Œé™æ€å†…éƒ¨ç±» ThreadLocalMap å¹¶æ²¡æœ‰å£°æ˜æ³›å‹å®šä¹‰ã€‚è€Œæ˜¯åœ¨ ThreadLocalMap çš„é™æ€å†…éƒ¨ç±» Entry ä¸­å£°æ˜äº†æ³›å‹å®šä¹‰ã€‚</p><div class="language-java line-numbers-mode" data-highlighter="shiki" data-ext="java" data-title="java" style="--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">static</span><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;"> class</span><span style="--shiki-light:#6F42C1;--shiki-dark:#E5C07B;"> Entry</span><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;"> extends</span><span style="--shiki-light:#6F42C1;--shiki-dark:#E5C07B;"> WeakReference</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">&lt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E5C07B;">ThreadLocal</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">&lt;</span><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">?</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">&gt;&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;"> {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#7F848E;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic;">    /** The value associated with this ThreadLocal. */</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E5C07B;">    Object</span><span style="--shiki-light:#24292E;--shiki-dark:#E06C75;"> value</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">    Entry</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#24292E;--shiki-dark:#E5C07B;">ThreadLocal</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">&lt;</span><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">?</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">&gt; </span><span style="--shiki-light:#E36209;--shiki-dark:#E06C75;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic;">k</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">, </span><span style="--shiki-light:#24292E;--shiki-dark:#E5C07B;">Object</span><span style="--shiki-light:#E36209;--shiki-dark:#E06C75;--shiki-light-font-style:inherit;--shiki-dark-font-style:italic;"> v</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">)</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;"> {</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#E5C07B;">        super</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">(k);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">        value </span><span style="--shiki-light:#D73A49;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;"> v;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">    }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>è¿™é‡Œåˆä¼šæ¶‰åŠåˆ°å¾ˆå¤šäººçš„ä¸€ä¸ªè¯¯åŒºã€‚å¾ˆå¤šäººé»˜è®¤æˆ–è€…åœ¨åˆšå¼€å§‹å­¦ä¹  ThreadLocal çš„æ—¶å€™è¯¯ä»¥ä¸ºåœ¨ä¸€ä¸ª ThreadLocalMap ä¸­å­˜å‚¨çš„æ˜¯ä¸€ç§ç±»å‹çš„ valueï¼Œå…¶å®ä¸ç„¶ï¼Œæºä»£ç å¾ˆæ¸…æ™°çš„å±•ç¤ºäº†ï¼ŒEntry çš„æˆå‘˜å˜é‡ Value çš„ç±»å‹æ˜¯ Objectï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œ<code>ä¸€ä¸ª ThreadLocalMap å¯ä»¥å­˜å‚¨ä»»ä½•ç±»å‹çš„ Value</code>ã€‚ç®€å•çš„è¯´ï¼Œåœ¨ä¸€ä¸ª Thread å¯¹è±¡çš„ threadLocals æˆå‘˜å˜é‡é‡Œï¼Œå­˜å‚¨çš„æ•°æ®å¯èƒ½æœ‰ Integerã€Stringã€List... ä»»ä½•ç±»å‹çš„æ•°æ®åŒæ—¶å­˜åœ¨ã€‚</p><p>åˆ°ç›®å‰ä¸ºæ­¢ï¼Œä¸¤ä¸ªç†è§£ ThreadLocal éå¸¸é‡è¦çš„ç‚¹å°±è®²æ¸…æ¥šäº†ã€‚å†æ€»ç»“ä¸€ä¸‹ï¼š</p><ul><li>çœŸæ­£å­˜å‚¨æ•°æ®çš„ ThreadLocalMap æ˜¯ä½œä¸º Thread çš„ä¸€ä¸ªæˆå‘˜å˜é‡å­˜åœ¨çš„ã€‚</li><li>ä¸€ä¸ª ThreadLocalMap å¯ä»¥å­˜å‚¨ä»»ä½•ç±»å‹çš„ Value<code>ï¼ˆè€Œä¸”ï¼Œä¸€å®šç¨‹åº¦ä¸Šæ¥è¯´ï¼Œä»–å­˜å‚¨çš„æ€»æ˜¯ä¸åŒç±»å‹çš„æ•°æ®ï¼‰</code>ã€‚</li></ul><p>æ‰€ä»¥ç°åœ¨å¤§å®¶å¤§æ¦‚æ‡‚ä»€ä¹ˆå«<code>â€œThreadLocal å®ç°äº†çº¿ç¨‹ç§æœ‰æ•°æ®å­˜å‚¨â€œ</code>äº†å§ï¼Ÿ</p><h3 id="ä»¥-android-æ¶æ„ä¸­çš„-looper-ä¸ºä¾‹" tabindex="-1"><a class="header-anchor" href="#ä»¥-android-æ¶æ„ä¸­çš„-looper-ä¸ºä¾‹"><span>ä»¥ Android æ¶æ„ä¸­çš„ Looper ä¸ºä¾‹</span></a></h3><p>åœ¨ Android çš„æ¶ˆæ¯æœºåˆ¶ä¸­ï¼ŒHandler å’Œ Looper æ˜¯ç´§å¯†ç›¸å…³çš„ã€‚å¦‚æœä½ ä¸äº†è§£æ¶ˆæ¯æœºåˆ¶ä¹Ÿæ²¡å…³ç³»ï¼Œç®€å•è§£é‡Šå°±æ˜¯ï¼ŒåŸºæœ¬æ¯ä¸€æ¡çº¿ç¨‹éƒ½è¦å¯¹åº”ä¸€ä¸ª Looperã€‚æ³¨æ„ï¼Œæ³¨æ„ï¼Œçœ‹æˆ‘è¿™å¥è¯ï¼šâ€œåŸºæœ¬æ¯ä¸€æ¡çº¿ç¨‹éƒ½è¦å¯¹åº”ä¸€ä¸ª Looperâ€œï¼Œèªæ˜çš„ä½ æƒ³åˆ°ä»€ä¹ˆï¼Ÿå¯¹ï¼å°±æ˜¯çº¿ç¨‹ç§æœ‰æ•°æ®çš„å­˜å‚¨ï¼æ‰€ä»¥ï¼Œæˆ‘ä»¬å°±å¯ä»¥ç”¨ ThreadLocal æ¥å­˜å‚¨ Looperã€‚</p><p>åœ¨ä½¿ç”¨ Handler ä¹‹å‰ï¼Œé¦–å…ˆè¦å…ˆè°ƒç”¨ Looper#prepare()ï¼š</p><div class="language-java line-numbers-mode" data-highlighter="shiki" data-ext="java" data-title="java" style="--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">public</span><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;"> static</span><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;"> void</span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;"> prepare</span><span style="--shiki-light:#24292E;--shiki-dark:#E06C75;">() {</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">    prepare</span><span style="--shiki-light:#24292E;--shiki-dark:#E06C75;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;">true</span><span style="--shiki-light:#24292E;--shiki-dark:#E06C75;">)</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E06C75;">}</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">private</span><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;"> static</span><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;"> void</span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;"> prepare</span><span style="--shiki-light:#24292E;--shiki-dark:#E06C75;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">boolean</span><span style="--shiki-light:#24292E;--shiki-dark:#E06C75;"> quitAllowed) {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">    if</span><span style="--shiki-light:#24292E;--shiki-dark:#E06C75;"> (</span><span style="--shiki-light:#24292E;--shiki-dark:#E5C07B;">sThreadLocal</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">get</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">()</span><span style="--shiki-light:#D73A49;--shiki-dark:#56B6C2;"> !=</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> null</span><span style="--shiki-light:#24292E;--shiki-dark:#E06C75;">) {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">        throw</span><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;"> new</span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;"> RuntimeException</span><span style="--shiki-light:#24292E;--shiki-dark:#E06C75;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#98C379;">&quot;Only one Looper may be created per thread&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E06C75;">)</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E06C75;">    }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E5C07B;">    sThreadLocal</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">set</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">new</span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;"> Looper</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">(quitAllowed));</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E06C75;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>é€šè¿‡ä»£ç æˆ‘ä»¬å¯ä»¥çœ‹å‡ºæ¥ï¼Œåœ¨ prepare æ–¹æ³•ä¸­ï¼Œé€šè¿‡ <code>sThreadLocal.set(new Looper(quitAllowed))</code>ã€‚</p><p>å†æ¥çœ‹ ThreadLocal#set(T value) æ–¹æ³•ï¼š</p><div class="language-java line-numbers-mode" data-highlighter="shiki" data-ext="java" data-title="java" style="--shiki-light:#24292e;--shiki-dark:#abb2bf;--shiki-light-bg:#fff;--shiki-dark-bg:#282c34;"><pre class="shiki shiki-themes github-light one-dark-pro vp-code"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">public</span><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;"> void</span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;"> set</span><span style="--shiki-light:#24292E;--shiki-dark:#E06C75;">(</span><span style="--shiki-light:#24292E;--shiki-dark:#E5C07B;">T</span><span style="--shiki-light:#24292E;--shiki-dark:#E06C75;"> value) {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E5C07B;">    Thread</span><span style="--shiki-light:#24292E;--shiki-dark:#E06C75;"> t </span><span style="--shiki-light:#D73A49;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E5C07B;"> Thread</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">currentThread</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">();</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E5C07B;">    ThreadLocalMap</span><span style="--shiki-light:#24292E;--shiki-dark:#E06C75;"> map </span><span style="--shiki-light:#D73A49;--shiki-dark:#56B6C2;">=</span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;"> getMap</span><span style="--shiki-light:#24292E;--shiki-dark:#E06C75;">(t)</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">    if</span><span style="--shiki-light:#24292E;--shiki-dark:#E06C75;"> (map </span><span style="--shiki-light:#D73A49;--shiki-dark:#56B6C2;">!=</span><span style="--shiki-light:#005CC5;--shiki-dark:#D19A66;"> null</span><span style="--shiki-light:#24292E;--shiki-dark:#E06C75;">) {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E5C07B;">        map</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">set</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#E5C07B;">this</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">, value);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E06C75;">    } </span><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">else</span><span style="--shiki-light:#24292E;--shiki-dark:#E06C75;"> {</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;">        createMap</span><span style="--shiki-light:#24292E;--shiki-dark:#E06C75;">(t</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">,</span><span style="--shiki-light:#24292E;--shiki-dark:#E06C75;"> value)</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E06C75;">    }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E06C75;">}</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E5C07B;">ThreadLocalMap</span><span style="--shiki-light:#6F42C1;--shiki-dark:#61AFEF;"> getMap</span><span style="--shiki-light:#24292E;--shiki-dark:#E06C75;">(</span><span style="--shiki-light:#24292E;--shiki-dark:#E5C07B;">Thread</span><span style="--shiki-light:#24292E;--shiki-dark:#E06C75;"> t) {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#C678DD;">    return</span><span style="--shiki-light:#24292E;--shiki-dark:#E5C07B;"> t</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">.</span><span style="--shiki-light:#24292E;--shiki-dark:#E5C07B;">threadLocals</span><span style="--shiki-light:#24292E;--shiki-dark:#ABB2BF;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E06C75;">}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>å¯ä»¥çœ‹åˆ°ï¼Œ<code>getMap(t)</code>å…¶å®å°±æ˜¯ç›´æ¥å–<code>å½“å‰çº¿ç¨‹</code>çš„æˆå‘˜å˜é‡ ThreadLocalMapã€‚ç„¶åä»¥ &lt;ThreadLocal, Looper&gt; è¿™ç§ &lt;Key, Value&gt; é”®å€¼å¯¹çš„å½¢å¼å°† Looper çš„ &lt;sThreadLocal, Looper()&gt; å­˜å…¥åˆ°<code>å½“å‰çº¿ç¨‹</code>çš„ ThreadLocalMap ä¸­ã€‚è¿™å°± callback åˆ°æœ€å¼€å§‹çš„é—®é¢˜ï¼š<code>å…¶ä»–çº¿ç¨‹çš„ Looper å†è°ƒç”¨ Looper#prepare(boolean quitAllowed) çš„æ—¶å€™å²‚ä¸ä¼šæŠŠä¹‹å‰çš„ Looper ç»™æ›¿ä»£äº†ï¼Ÿ</code>ã€‚</p><div class="hint-container tip"><p class="hint-container-title">ç­”æ¡ˆ</p><p><code>å½“ç„¶æ˜¯ä¸ä¼š</code>ã€‚</p><p>ä»¥ sThreadLocal ä¸º Key çš„é”®å€¼å¯¹å­˜åˆ°çš„æ˜¯å½“å‰ Thread 1 çš„ ThreadLocalMap ä¸­.</p><p>è€Œåœ¨ Android ä¸­ï¼ŒLooper å’Œ Thread æ˜¯ä¸€ä¸€å¯¹åº”çš„ï¼ˆå¦‚æœ Thread æœ‰ Looper çš„è¯ï¼ŒThread å¯ä»¥æ²¡æœ‰ Looperï¼‰ï¼Œå…¶ä»–çº¿ç¨‹ Thread 2 å†è°ƒç”¨ Looper#prepare(boolean quitAllowed) æ–¹æ³•çš„æ—¶å€™ä¼šå°†æ–°ä¸€ä¸ª Looper å­˜åˆ°å…¶å¯¹åº” Thread 2 çš„ ThreadLocalMapã€‚</p><p>ä¸åŒ Thread çš„ ThreadLocalMap ä¸­å¯èƒ½æœ‰ç›¸åŒçš„ Keyï¼Œä½†æ˜¯å¯¹åº”çš„ Value æ˜¯ä¸åŒçš„ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼ŒLooper ä¸­çš„é™æ€å˜é‡ sThreadLocal æ˜¯å¯ä»¥ä½œä¸º Key å‡ºç°åœ¨ä¸åŒçš„ Thread çš„ ThreadLocalMap ä¸­ï¼Œåªæ˜¯å¯¹åº”çš„ Valueï¼ˆLooperï¼‰æ˜¯ä¸åŒçš„ã€‚</p></div><p><img src="`+e+'" alt="æ¶æ„å›¾"></p>',38),t=[h];function p(k,r){return a(),s("div",null,t)}const c=i(n,[["render",p],["__file","ThreadLocalPersonalUnderstanding.html.vue"]]),g=JSON.parse('{"path":"/java/concurrency/ThreadLocalPersonalUnderstanding.html","title":"ThreadLocal ä¸ªäººç†è§£","lang":"zh-CN","frontmatter":{"title":"ThreadLocal ä¸ªäººç†è§£","author":"Evan","editLink":false,"comment":false,"tag":["Android"],"date":"2025-03-26T00:00:00.000Z","description":"å¾ˆå¤šï¼ˆæˆ‘å°±ç›´æ¥ä»£è¡¨å¾ˆå¤šäººäº†ğŸ¶ï¼‰åš Android çš„åŒå­¦è®¤è¯†å’Œå­¦ä¹  ThreadLocal éƒ½æ˜¯é€šè¿‡ Looper ä¸­çš„ sThreadLocal è¿™ä¸ªé™æ€å˜é‡å¼€å§‹çš„ï¼Œç„¶åå°±ä¼šè¿›å…¥ä¸€ä¸ªè¯¯åŒºï¼šsThreadLocal æ˜¯ Looper ä¸­çš„ä¸€ä¸ªé™æ€å˜é‡å•Šï¼Œå½“ Looper#prepare(boolean quitAllowed) æ–¹æ³•è°ƒç”¨ sThrea...","head":[["meta",{"property":"og:url","content":"https://leslie-dd.github.io/leslie-blog/leslie-blog/java/concurrency/ThreadLocalPersonalUnderstanding.html"}],["meta",{"property":"og:site_name","content":"Evan çš„åšå®¢"}],["meta",{"property":"og:title","content":"ThreadLocal ä¸ªäººç†è§£"}],["meta",{"property":"og:description","content":"å¾ˆå¤šï¼ˆæˆ‘å°±ç›´æ¥ä»£è¡¨å¾ˆå¤šäººäº†ğŸ¶ï¼‰åš Android çš„åŒå­¦è®¤è¯†å’Œå­¦ä¹  ThreadLocal éƒ½æ˜¯é€šè¿‡ Looper ä¸­çš„ sThreadLocal è¿™ä¸ªé™æ€å˜é‡å¼€å§‹çš„ï¼Œç„¶åå°±ä¼šè¿›å…¥ä¸€ä¸ªè¯¯åŒºï¼šsThreadLocal æ˜¯ Looper ä¸­çš„ä¸€ä¸ªé™æ€å˜é‡å•Šï¼Œå½“ Looper#prepare(boolean quitAllowed) æ–¹æ³•è°ƒç”¨ sThrea..."}],["meta",{"property":"og:type","content":"article"}],["meta",{"property":"og:locale","content":"zh-CN"}],["meta",{"property":"og:updated_time","content":"2025-03-26T13:33:52.000Z"}],["meta",{"property":"article:author","content":"Evan"}],["meta",{"property":"article:tag","content":"Android"}],["meta",{"property":"article:published_time","content":"2025-03-26T00:00:00.000Z"}],["meta",{"property":"article:modified_time","content":"2025-03-26T13:33:52.000Z"}],["script",{"type":"application/ld+json"},"{\\"@context\\":\\"https://schema.org\\",\\"@type\\":\\"Article\\",\\"headline\\":\\"ThreadLocal ä¸ªäººç†è§£\\",\\"image\\":[\\"\\"],\\"datePublished\\":\\"2025-03-26T00:00:00.000Z\\",\\"dateModified\\":\\"2025-03-26T13:33:52.000Z\\",\\"author\\":[{\\"@type\\":\\"Person\\",\\"name\\":\\"Evan\\"}]}"]]},"headers":[{"level":2,"title":"ThreadLocal æ˜¯æ€ä¹ˆå­˜æ•°æ®çš„ï¼Ÿ","slug":"threadlocal-æ˜¯æ€ä¹ˆå­˜æ•°æ®çš„","link":"#threadlocal-æ˜¯æ€ä¹ˆå­˜æ•°æ®çš„","children":[]},{"level":2,"title":"ThreadLocal å­˜åœ¨çš„æ„ä¹‰æ˜¯ä»€ä¹ˆï¼Ÿ","slug":"threadlocal-å­˜åœ¨çš„æ„ä¹‰æ˜¯ä»€ä¹ˆ","link":"#threadlocal-å­˜åœ¨çš„æ„ä¹‰æ˜¯ä»€ä¹ˆ","children":[]},{"level":2,"title":"ThreadLocal/ThreadLocalMap æ€ä¹ˆå®ç°çº¿ç¨‹éš”ç¦»çš„","slug":"threadlocal-threadlocalmap-æ€ä¹ˆå®ç°çº¿ç¨‹éš”ç¦»çš„","link":"#threadlocal-threadlocalmap-æ€ä¹ˆå®ç°çº¿ç¨‹éš”ç¦»çš„","children":[{"level":3,"title":"1. Thread å’Œ ThreadLocalMap çš„å…³ç³»","slug":"_1-thread-å’Œ-threadlocalmap-çš„å…³ç³»","link":"#_1-thread-å’Œ-threadlocalmap-çš„å…³ç³»","children":[]},{"level":3,"title":"2. æ³›å‹åœ¨ ThreadLocal ä¸­çš„åº”ç”¨ã€‚","slug":"_2-æ³›å‹åœ¨-threadlocal-ä¸­çš„åº”ç”¨ã€‚","link":"#_2-æ³›å‹åœ¨-threadlocal-ä¸­çš„åº”ç”¨ã€‚","children":[]},{"level":3,"title":"ä»¥ Android æ¶æ„ä¸­çš„ Looper ä¸ºä¾‹","slug":"ä»¥-android-æ¶æ„ä¸­çš„-looper-ä¸ºä¾‹","link":"#ä»¥-android-æ¶æ„ä¸­çš„-looper-ä¸ºä¾‹","children":[]}]}],"git":{"createdTime":1742996032000,"updatedTime":1742996032000,"contributors":[{"name":"Leslie","email":"LeslieDYF@gmail.com","commits":1}]},"readingTime":{"minutes":5.35,"words":1605},"filePathRelative":"java/concurrency/ThreadLocalPersonalUnderstanding.md","localizedDate":"2025å¹´3æœˆ26æ—¥","excerpt":"<blockquote>\\n<p>å¾ˆå¤šï¼ˆæˆ‘å°±ç›´æ¥ä»£è¡¨å¾ˆå¤šäººäº†ğŸ¶ï¼‰åš Android çš„åŒå­¦è®¤è¯†å’Œå­¦ä¹  ThreadLocal éƒ½æ˜¯é€šè¿‡ Looper ä¸­çš„ sThreadLocal è¿™ä¸ªé™æ€å˜é‡å¼€å§‹çš„ï¼Œç„¶åå°±ä¼šè¿›å…¥ä¸€ä¸ªè¯¯åŒºï¼šsThreadLocal æ˜¯ Looper ä¸­çš„ä¸€ä¸ªé™æ€å˜é‡å•Šï¼Œå½“ <code>Looper#prepare(boolean quitAllowed)</code> æ–¹æ³•è°ƒç”¨  <code>sThreadLocal.set(new Looper(quitAllowed))</code> çš„æ—¶å€™å­˜åˆ° ThreadLocalMap ä¸­çš„ value (Looper) çš„ key å€¼ç«Ÿç„¶æ˜¯ thisï¼Œä¹Ÿå°±æ˜¯ sThreadLocal è¿™ä¸ªé™æ€å˜é‡ï¼Ÿé‚£ä¸€ä¸ªé™æ€å˜é‡æ€ä¹ˆèƒ½ä½œä¸º keyå€¼å‘¢ï¼Ÿé™æ€å˜é‡åœ¨è¿™ä¸ªè¿›ç¨‹ä¸­å¯æ˜¯ç‹¬ä¸€ä»½å•Šï¼Œå…¶ä»–çº¿ç¨‹çš„ Looper å†è°ƒç”¨ Looper#prepare(boolean quitAllowed) çš„æ—¶å€™å²‚ä¸ä¼šæŠŠä¹‹å‰çš„ Looper ç»™æ›¿ä»£äº†ï¼Ÿ</p>\\n</blockquote>","autoDesc":true}');export{c as comp,g as data};
